<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlockPilot - Verify</title>
  
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if(EMBED) document.documentElement.classList.add('embed');</script>

  <style>
    :root {
      --bp-primary: #3C756E; --bp-bg: #FFFFFF; --bp-border: #E2E8F0; --bp-text: #0F172A; --bp-muted: #64748B;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bp-bg); color: var(--bp-text);
    }
    .embed body { padding: 0; background: transparent; }
    
    .container { max-width: 600px; margin: 0 auto; }
    .embed .container { max-width: 100%; }

    /* Header Int */
    .header-int { display: flex; align-items: center; margin-bottom: 24px; border-bottom: 1px solid var(--bp-border); padding-bottom: 16px; }
    .embed .header-int { display: none; }

    h1 { font-size: 24px; font-weight: 700; margin: 0 0 8px; color: var(--bp-primary); }
    p.sub { font-size: 15px; color: var(--bp-muted); margin: 0 0 16px; }

    textarea {
      width: 100%; height: 120px; padding: 12px; border: 1px solid var(--bp-border); border-radius: 12px;
      font-family: monospace; font-size: 13px; color: #334155; resize: vertical; margin-bottom: 16px; outline: none;
    }
    textarea:focus { border-color: var(--bp-primary); box-shadow: 0 0 0 3px rgba(60,117,110,0.1); }

    .btn {
      display: flex; align-items: center; justify-content: center; width: 100%;
      padding: 12px; border-radius: 99px; font-weight: 600; cursor: pointer; border: none; font-size: 15px;
      background: var(--bp-primary); color: white;
    }
    .btn:hover { background: #2E5C56; }

    /* Result Box */
    .res-box { display: none; margin-top: 24px; padding: 16px; border-radius: 12px; border: 1px solid transparent; word-break: break-all; }
    .res-box.ok { background: #ECFDF5; border-color: #A7F3D0; color: #064E3B; }
    .res-box.err { background: #FEF2F2; border-color: #FECACA; color: #991B1B; }
    .res-box.warn { background: #FFFBEB; border-color: #FDE68A; color: #92400E; }

    .res-row { margin-bottom: 4px; font-size: 14px; }
    .res-row code { background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: 600; }
  </style>
</head>
<body>

  <div class="header-int">
    <img src="assets/logo.png" alt="BPC" height="32">
  </div>

  <div class="container">
    <h1 id="title">Verify Signature</h1>
    <p id="intro" class="sub">Paste a BPC1 token or a legacy signed block.</p>

    <textarea id="inputData" placeholder="Paste BPC1.xxxx or Signed Block here..."></textarea>
    
    <button id="verifyBtn" class="btn">üîç Verify</button>

    <div id="result" class="res-box"></div>
    <div id="pdfCheck" class="res-box"></div>
  </div>

<script>
  // CONFIG
  const PDFs = { standard: 'BPC_Terms.pdf', seed: 'BPC_Terms_Seed.pdf' };
  
  // I18N
  const STR = {
    en: { title:'Verify Signature', intro:'Paste BPC1 token or signed block.', btn:'üîç Verify', valid:'‚úÖ Valid Signature', invalid:'‚ùå Invalid Signature', err:'‚ö†Ô∏è Error' },
    fr: { title:'V√©rifier Signature', intro:'Collez un token BPC1 ou un bloc sign√©.', btn:'üîç V√©rifier', valid:'‚úÖ Signature Valide', invalid:'‚ùå Signature Invalide', err:'‚ö†Ô∏è Erreur' }
  };
  const getLang = () => (new URLSearchParams(location.search).get('lang') || localStorage.getItem('bp_lang') || 'fr').startsWith('en') ? 'en' : 'fr';
  let lang = getLang();
  const t = (k) => STR[lang][k] || STR.en[k];

  // UI
  document.getElementById('title').textContent = t('title');
  document.getElementById('intro').textContent = t('intro');
  document.getElementById('verifyBtn').textContent = t('btn');

  // VERIFY LOGIC
  async function verify() {
    const input = document.getElementById('inputData').value.trim();
    const out = document.getElementById('result');
    const pdfBox = document.getElementById('pdfCheck');
    
    out.style.display='none'; pdfBox.style.display='none';

    if(!input) return;

    try {
      let address, pdf, pdfHash, timestamp, signature, docId, origin;
      let isLegacy = false;

      // PARSING
      if (input.startsWith('BPC1.')) {
        // TOKEN MODE
        const json = decodeURIComponent(escape(atob(input.slice(5))));
        const p = JSON.parse(json);
        address = p.address; pdf = p.pdf; pdfHash = p.pdfHash;
        timestamp = p.timestamp; signature = p.signature;
        docId = p.docId; origin = p.origin;
      } else {
        // LEGACY BLOCK PARSING
        let m = input.match(/Signed as: (0x[a-fA-F0-9]{40})/);
        if(!m) throw new Error("Format Inconnu");
        address = m[1];

        m = input.match(/Signature:\s*(0x[a-fA-F0-9]{130,})/s);
        signature = m ? m[1] : null;
        
        m = input.match(/PDF Hash: (0x[a-fA-F0-9]{64})/);
        pdfHash = m ? m[1] : null;

        m = input.match(/Timestamp: (.*?)$/m);
        timestamp = m ? m[1] : null;
        
        if(!pdfHash) isLegacy = true; // Very old format
      }

      if(!signature) throw new Error("No Signature found");

      // RECONSTRUCT MESSAGE
      let message;
      if(docId && origin) {
         // Modern Format
         message = `I, ${address}, agree to the BPC Terms (${pdf||'BPC_Terms.pdf'})\nDoc ID: ${docId}\nOrigin: ${origin}\nPDF Hash: ${pdfHash}\nSigned on: ${timestamp}`;
      } else {
         // Fallback/Legacy
         message = `I, ${address}, agree to the BPC Terms (${pdf||'BPC_Terms.pdf'})\nPDF Hash: ${pdfHash}\nSigned on: ${timestamp}`;
      }

      // CHECK SIG
      const recovered = ethers.utils.verifyMessage(message, signature);
      
      if(recovered.toLowerCase() === address.toLowerCase()) {
        // SUCCESS
        out.className = 'res-box ok';
        out.style.display = 'block';
        out.innerHTML = `
          <strong>${t('valid')}</strong><br>
          <div class="res-row">Signer: <code>${address}</code></div>
          <div class="res-row">Date: <code>${timestamp}</code></div>
        `;

        // CHECK PDF INTEGRITY
        if(pdfHash) {
          try {
             // Try to fetch PDF to check hash
             const r = await fetch(pdf || 'BPC_Terms.pdf');
             if(r.ok) {
                const buf = new Uint8Array(await r.arrayBuffer());
                const realHash = '0x' + keccak256(buf);
                if(realHash === pdfHash) {
                   pdfBox.className = 'res-box ok';
                   pdfBox.innerHTML = `üßÆ PDF Hash Verified (Match)`;
                   pdfBox.style.display = 'block';
                } else {
                   pdfBox.className = 'res-box err';
                   pdfBox.innerHTML = `‚ö†Ô∏è PDF Mismatch! Server: ${realHash} / Sig: ${pdfHash}`;
                   pdfBox.style.display = 'block';
                }
             }
          } catch(e) { console.log(e); }
        }

      } else {
        throw new Error("Signature mismatch");
      }

    } catch(e) {
      console.error(e);
      out.className = 'res-box err';
      out.style.display = 'block';
      out.textContent = t('invalid') + " (" + e.message + ")";
    }
  }

  document.getElementById('verifyBtn').onclick = verify;
</script>
</body>
</html>
