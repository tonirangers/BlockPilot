<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BPC ‚Äî Sign (Standard & Seed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f9f9f9;display:flex;justify-content:center;align-items:center;padding:40px 20px;margin:0}
    .container{background:#fff;padding:30px;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,.05);max-width:680px;width:100%;text-align:center}
    .logo{height:150px;display:block;margin:0 auto 12px}
    .tabs{display:flex;gap:8px;justify-content:center;margin:8px 0 16px}
    .tab{padding:8px 12px;border-radius:999px;background:#eaf2ff;color:#0a6cff;text-decoration:none;font-weight:600;cursor:pointer;user-select:none}
    .tab.active{background:#0a6cff;color:#fff}
    h1{font-size:26px;margin:0 0 10px}
    p{font-size:16px;margin-bottom:16px}
    :root{--blue:#0a6cff;--blueH:#055ad6;--ghost:#eaf2ff}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;margin:10px 0;padding:14px;border-radius:12px;font-size:16px;font-weight:700;text-decoration:none;border:0;cursor:pointer}
    .btn-ghost{background:var(--ghost);color:var(--blue)}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blueH)}
    .hash-line{font-size:14px;color:#555;margin:18px 0;word-break:break-word}
    .output-box{background:#f5f5f5;padding:16px;border-radius:10px;margin-top:20px;text-align:left;overflow-wrap:anywhere}
    .copy-btn{background:#28a745;color:#fff;padding:10px 14px;border:0;border-radius:8px;font-size:14px;margin:6px 6px 0 0;cursor:pointer;display:inline-block}
    .copy-btn:hover{background:#1e7e34}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .btn{flex:1 1 240px}
    .small{font-size:13px;color:#666;margin-top:8px}
    .muted{color:#666}
    .qr-wrap{margin-top:12px;display:flex;justify-content:center}
    canvas.qr{background:#fff;border:1px solid #e5e5e5;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <a href="sign.html" aria-label="Home"><img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'"></a>

    <nav class="tabs">
      <span class="tab" id="tab-standard">Standard</span>
      <span class="tab" id="tab-seed">Seed</span>
    </nav>

    <h1 id="title">Sign Terms &amp; Conditions</h1>
    <p id="subtitle" class="muted">By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

    <div class="row">
      <a id="viewPdfBtn" class="btn btn-ghost" href="./BPC_Terms.pdf" target="_blank" rel="noopener">üìÑ View PDF Terms</a>
      <button id="signBtn" class="btn btn-primary" disabled>‚è≥ Preparing‚Ä¶</button>
    </div>

    <div class="hash-line">PDF (<span id="pdfName">BPC_Terms.pdf</span>) ‚Ä¢ Keccak-256: <span id="pdfHash">‚Ä¶</span></div>

    <div id="signatureOutput"></div>

    <p class="small">‚úÖ You can verify signatures anytime on <a href="verify.html">verify.html</a>.</p>
  </div>

<script>
  // ---- Config
  const PDFs = { standard: './BPC_Terms.pdf', seed: './BPC_Terms_Seed.pdf' };
  const TERMS_META = {
    standard: { docId: 'BPC_Terms v1.0 (2025-11-07)' },
    seed:     { docId: 'BPC_Terms_Seed v1.0 (2025-11-07)' }
  };
  // Nouveau webhook (Apps Script)
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzOmjt11dQ3vmYtVrydXl6gejh0lVwqiSxCbXMhUVpQPNBFoMTUP2JJlAj0atjTOcfDtg/exec';

  // ---- State
  let mode = 'standard';
  let pdfPath = PDFs[mode];
  let pdfHash = '';
  let signing = false;

  // ---- Init
  document.addEventListener('DOMContentLoaded', () => {
    const params = getHashParams();
    if (params.mode === 'seed') mode = 'seed';
    applyMode();
  });

  document.getElementById('tab-standard').addEventListener('click', () => { mode='standard'; applyMode(true); });
  document.getElementById('tab-seed').addEventListener('click', () => { mode='seed'; applyMode(true); });
  document.getElementById('signBtn').addEventListener('click', signTerms);

  function getHashParams() {
    const h = (location.hash||'').replace(/^#/,'');
    const o = {};
    h.split('&').forEach(kv => {
      const [k,v] = kv.split('=');
      if (k) o[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
    });
    return o;
  }

  async function applyMode(pushHash=false) {
    pdfPath = PDFs[mode];
    // tabs
    document.getElementById('tab-standard').classList.toggle('active', mode==='standard');
    document.getElementById('tab-seed').classList.toggle('active', mode==='seed');
    // titles
    document.getElementById('title').textContent = mode==='standard' ? 'Sign Terms & Conditions' : 'Sign Terms & Conditions (Seed)';
    document.getElementById('subtitle').textContent = mode==='standard'
      ? 'By signing, you confirm you‚Äôve read and agree to the official BPC Terms.'
      : 'By signing, you confirm you‚Äôve read and agree to the official BPC Seed Terms.';
    // links
    document.getElementById('viewPdfBtn').href = pdfPath;
    document.getElementById('pdfName').textContent = pdfPath;

    // clear previous receipt when switching tab
    document.getElementById('signatureOutput').innerHTML = '';

    // disable button while hashing
    const btn = document.getElementById('signBtn');
    signing = false;
    btn.disabled = true; btn.textContent = '‚è≥ Preparing‚Ä¶';

    // compute hash
    pdfHash = '';
    document.getElementById('pdfHash').textContent = '‚Ä¶';
    try {
      const r = await fetch(pdfPath + '?v=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Fetch PDF failed: ' + r.status);
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
      btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign with Wallet';
    } catch(e){
      console.error('PDF hash error:', e);
      btn.disabled = true; btn.textContent = '‚ö†Ô∏è PDF hash error';
    }

    if (pushHash) location.hash = `mode=${mode}`;
  }

  async function signTerms() {
    if (signing) return;
    const btn = document.getElementById('signBtn');
    try {
      if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask)'); return; }
      signing = true; btn.disabled = true; btn.textContent = 'üîê Waiting wallet‚Ä¶';

      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      for (let i=0;i<50 && !pdfHash;i++) await new Promise(r=>setTimeout(r,100));
      if (!pdfHash) { alert('PDF hash not ready yet. Please retry in 1s.'); signing = false; btn.disabled=false; btn.textContent='‚úçÔ∏è Sign with Wallet'; return; }

      const timestamp = new Date().toISOString();
      const origin = location.origin;
      const docId = TERMS_META[mode].docId;

      const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      let signature;
      try {
        signature = await signer.signMessage(message);
      } catch {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      const block =
`Signed as: ${address}
Doc ID: ${docId}
Origin: ${origin}
PDF: ${pdfPath}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      const payload = { mode, address, pdf: pdfPath, pdfHash, timestamp, signature, origin, docId, userAgent: navigator.userAgent };
      const token   = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const verifyUrl = new URL('verify.html', location.href).toString();
      const verifyLink = `${verifyUrl}#mode=${mode}&token=${encodeURIComponent(token)}`;

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      // Log to Google Sheets (best-effort)
      if (WEBHOOK_URL) {
        try {
          await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' }, // simple => pas de preflight
            body: JSON.stringify(payload)
          });
        } catch (e) { /* silencieux */ }
      }

      // Render receipt
      document.getElementById('signatureOutput').innerHTML = `
        <div class="output-box">
          ‚úÖ <b>Signed as:</b> ${address} <span class="muted">[${mode}]</span><br>
          üïí <b>Timestamp:</b> ${timestamp}<br>
          üìÑ <b>Doc ID:</b> ${docId}<br>
          üåê <b>Origin:</b> ${origin}<br>
          üìò <b>PDF:</b> ${pdfPath}<br>
          üßÆ <b>PDF Hash:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>Signature:</b><br>${signature}<br><br>
          <button class="copy-btn" onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)' title="Copier le bloc lisible">üìã Copy block</button>
          <button class="copy-btn" onclick='copyText(\`${token}\`)' title="Un seul champ √† coller pour v√©rifier">üîë Copy token</button>
          <a class="copy-btn" href="${jsonUrl}" download="bpc-signature-${address}.json" title="Re√ßu JSON">‚¨áÔ∏è Download JSON</a>
          <a class="copy-btn" href="${verifyLink}" target="_blank" rel="noopener" title="Lien direct de v√©rification">üîó Verify via link</a>
          <div class="qr-wrap">
            <canvas id="qrCanvas" class="qr" width="320" height="320"></canvas>
          </div>
        </div>
      `;

      // QR code (plus grand + correction)
      const canvas = document.getElementById('qrCanvas');
      const url = verifyLink;
      try {
        if (!window.QRCode || !QRCode.toCanvas) throw new Error('QRCode lib missing');
        await QRCode.toCanvas(canvas, url, {
          width: 320,
          margin: 2,
          errorCorrectionLevel: 'M',
          color: { dark: '#000000', light: '#FFFFFF' }
        });
      } catch (err) {
        console.error('QR canvas failed, fallback to IMG', err);
        try {
          const dataUrl = await QRCode.toDataURL(url, {
            width: 320, margin: 2, errorCorrectionLevel: 'M',
            color: { dark: '#000000', light: '#FFFFFF' }
          });
          const img = new Image();
          img.width = 320; img.height = 320; img.style.borderRadius = '8px'; img.style.border = '1px solid #e5e5e5';
          img.src = dataUrl;
          canvas.replaceWith(img);
        } catch (e2) {
          console.error('QR fallback failed', e2);
        }
      }

      // reset button
      signing = false; btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign again';
    } catch (err) {
      console.error(err);
      signing = false;
      const btn = document.getElementById('signBtn');
      btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign with Wallet';
      alert('Signing cancelled or failed.');
    }
  }

  function copyText(s){ navigator.clipboard.writeText(s||''); alert('Copied!'); }
</script>
</body>
</html>
