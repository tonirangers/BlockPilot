<!DOCTYPE html>
<html lang="en">
<head>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verify Signature</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f4f4f4;margin:0;padding:40px 20px;display:flex;align-items:center;justify-content:center}
    .container{max-width:640px;width:100%;background:#fff;padding:30px;border-radius:16px;box-shadow:0 0 12px rgba(0,0,0,.05);text-align:center}
    .logo{height:150px;display:block;margin:0 auto 12px}
    h2{font-size:26px;margin:0 0 10px}
    p{font-size:16px;margin:0 0 14px}

    :root{--blue:#0a6cff;--blueH:#055ad6;--ghost:#eaf2ff}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:700;text-decoration:none;border:0;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blueH)}

    textarea{width:100%;padding:12px;font-family:monospace;font-size:14px;border-radius:8px;border:1px solid #ccc;resize:vertical;min-height:120px;margin:10px 0 16px}
    .result{margin-top:16px;padding:16px;border-radius:10px;font-size:14px;text-align:left;word-break:break-word;overflow-wrap:anywhere}
    .ok{background:#d4edda;color:#155724}
    .err{background:#f8d7da;color:#721c24}
    .warn{background:#fff3cd;color:#856404}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .btn{flex:1 1 180px}
    .small{font-size:13px;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'">
    <h2>Verify Signature</h2>
    <p>Paste your <b>verify token</b> (starts with <code>BPC1.</code>) <i>or</i> the full legacy block.</p>

    <textarea id="inputData" placeholder="BPC1.eyJhZGRyZXNzIjoiMHh...  OR

Signed as: 0x...
PDF Hash: 0x...
Timestamp: 2025-...
Signature:
0x..."></textarea>

    <div class="row">
      <button class="btn btn-primary" id="verifyBtn">üîç Verify</button>
    </div>

    <div id="result" class="result" style="display:none"></div>
    <div id="pdfCheck" class="result warn" style="display:none"></div>
  </div>

<script>
  // Auto-verify if a token is passed in the URL hash (#token=...)
  window.addEventListener('DOMContentLoaded', () => {
    const h = location.hash;
    if (h.startsWith('#token=')) {
      const token = decodeURIComponent(h.slice(7));
      document.getElementById('inputData').value = token;
      verify();
    }
  });

  document.getElementById('verifyBtn').addEventListener('click', verify);

  async function verify() {
    const box = document.getElementById('inputData');
    const out = document.getElementById('result');
    const pdfBox = document.getElementById('pdfCheck');
    out.style.display = 'none'; pdfBox.style.display = 'none';
    out.className = 'result'; pdfBox.className = 'result warn';

    let input = box.value.trim();
    if (!input) return;

    try {
      let address, pdf, pdfHash, timestamp, signature;

      if (input.startsWith('BPC1.')) {
        // MODE 1: compact token (recommended)
        const json = decodeURIComponent(escape(atob(input.slice(5))));
        const p = JSON.parse(json);
        ({ address, pdf, pdfHash, timestamp, signature } = p);
      } else {
        // MODE 2: legacy multi-line block
        const m = input.match(
          /Signed as: (0x[a-fA-F0-9]{40})\nPDF Hash: (0x[a-fA-F0-9]{64})\nTimestamp: (.*?)\nSignature:\n(0x[a-fA-F0-9]{130,})/s
        );
        if (!m) {
          out.classList.add('err');
          out.style.display = 'block';
          out.textContent = '‚ö†Ô∏è Paste either the token (starts with BPC1.) or the full block.';
          return;
        }
        [, address, pdfHash, timestamp, signature] = m;
        pdf = 'BPC_Terms.pdf';
      }

      // Rebuild message exactly as signed
      const message =
`I, ${address}, agree to the BPC Terms (${pdf})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      const recovered = ethers.utils.verifyMessage(message, signature);

      if (recovered.toLowerCase() === address.toLowerCase()) {
        out.classList.add('ok');
        out.style.display = 'block';
        out.innerHTML =
          `‚úÖ <b>Valid Signature</b><br>`+
          `Recovered Address: <code>${recovered}</code><br>`+
          `PDF: <code>${pdf}</code><br>`+
          `PDF Hash: <code>${pdfHash}</code><br>`+
          `Timestamp: <code>${timestamp}</code>`;
      } else {
        out.classList.add('err');
        out.style.display = 'block';
        out.innerHTML = `‚ùå <b>Invalid Signature</b><br>Recovered Address: <code>${recovered}</code>`;
        return; // stop here if signature invalid
      }

      // Optional: re-compute the hash of the PDF on the server and compare
      try {
        const res = await fetch(pdf, { cache: 'no-store' });
        if (res.ok) {
          const buf = new Uint8Array(await res.arrayBuffer());
          const actual = '0x' + keccak256(buf);
          if (actual.toLowerCase() === pdfHash.toLowerCase()) {
            pdfBox.className = 'result ok';
            pdfBox.innerHTML = `üßÆ PDF hash matches on server.`;
          } else {
            pdfBox.className = 'result warn';
            pdfBox.innerHTML =
              `‚ö†Ô∏è PDF hash mismatch on server.<br>`+
              `Expected: <code>${pdfHash}</code><br>`+
              `Server: <code>${actual}</code>`;
          }
          pdfBox.style.display = 'block';
        }
      } catch (e) {
        // ignore network/CORS; page will still validate signature
      }

    } catch (e) {
      console.error(e);
      out.classList.add('err');
      out.style.display = 'block';
      out.textContent = '‚ùå Error verifying signature';
    }
  }
</script>
</body>
</html>
