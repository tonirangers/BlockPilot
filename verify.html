<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BPC ‚Äî V√©rification</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if (EMBED) document.documentElement.classList.add('embed');</script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 18px;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .embed body{background:transparent;padding:0;display:block;}
    .container{max-width:760px;width:100%;background:var(--card);padding:24px;border-radius:18px;border:1px solid var(--line);box-shadow:var(--shadow);text-align:center}
    .embed .container{box-shadow:none;border:0;border-radius:0;padding:0;background:transparent;text-align:left;}
    .logo{height:96px;width:96px;display:block;margin:0 auto 12px;border-radius:18px;border:1px solid var(--line);box-shadow:0 10px 24px rgba(13,35,31,.08)}
    .embed .logo{display:none;}
    .note{font-size:14px;margin:0 0 12px;color:rgba(13,35,31,.65);font-weight:750;}
    h2{font-size:24px;margin:0 0 10px}
    p{font-size:16px;margin:0 0 14px;color:var(--muted);font-weight:650}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:14px;font-size:16px;font-weight:900;text-decoration:none;border:1px solid rgba(13,35,31,.14);cursor:pointer;background:var(--brand);color:#fff;box-shadow:0 12px 26px rgba(13,35,31,.06)}
    .btn:hover{background:var(--brand2)}
    textarea{width:100%;padding:14px;font-family:monospace;font-size:14px;border-radius:14px;border:1px solid var(--line);resize:vertical;min-height:140px;margin:10px 0 16px;background:#fff;box-shadow:inset 0 1px 2px rgba(13,35,31,.04);color:var(--ink)}
    textarea:focus{border-color:rgba(11,111,102,.55); box-shadow:0 0 0 4px rgba(11,111,102,.10); outline:none}
    .result{margin-top:16px;padding:16px;border-radius:12px;font-size:14px;text-align:left;word-break:break-word;overflow-wrap:anywhere;border:1px solid var(--line);background:rgba(238,247,245,.45)}
    .ok{background:rgba(11,111,102,.12);color:var(--brand2);border-color:rgba(11,111,102,.35)}
    .err{background:#f8d7da;color:#721c24;border-color:#f1b0b7}
    .warn{background:#fff3cd;color:#856404;border-color:#ffe8a1}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" aria-label="Home"><img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'"></a>

    <h2 id="title">Verify Signature</h2>
    <p class="muted" id="intro">Paste your <b>verify token</b> (starts with <code>BPC1.</code>) or a full block (new or legacy).</p>
    <p class="note" id="modeNote">Standard &amp; Seed documents are detected automatically.</p>

    <textarea id="inputData" placeholder="BPC1.eyJhZGRyZXNzIjoiMHh...  OR

Signed as: 0x...
Doc ID: BPC_Terms v1.0 (2025-11-07)
Origin: https://yourdomain.tld
PDF: BPC_Terms.pdf
PDF Hash: 0x...
Timestamp: 2025-...
Signature:
0x...

‚ÄîOR‚Äî

Signed as: 0x... as of 2025-...
Signature:
0x...                    ‚Üê legacy v0"></textarea>

    <button class="btn" id="verifyBtn">üîç Verify</button>

    <div id="result" class="result" style="display:none"></div>
    <div id="pdfCheck" class="result warn" style="display:none"></div>
  </div>

<script>
  const PDFs = { standard: 'BPC_Terms.pdf', seed: 'BPC_Terms_Seed.pdf' };
  const DOC_IDS = { standard: 'BPC_Terms v1.0 (2025-11-07)', seed: 'BPC_Terms_Seed v1.0 (2025-11-07)' };

  function inferDocId(pdf){
    if (!pdf) return null;
    const key = pdf.toLowerCase().includes('seed') ? 'seed' : 'standard';
    return DOC_IDS[key];
  }

  function renderCopy(){
    document.documentElement.lang = lang;
    const titleEl=document.getElementById('title');
    if (titleEl) titleEl.textContent=t('title');
    const intro=document.getElementById('intro');
    if (intro) intro.textContent=t('intro');
    const note=document.getElementById('modeNote');
    if (note) note.textContent=t('modeNote');
    const box=document.getElementById('inputData');
    if (box) box.placeholder=t('placeholder');
    const btn=document.getElementById('verifyBtn');
    if (btn) btn.textContent=t('verifyBtn');
  }

  const STR = {
    en: {
      title:'Verify signature', intro:'Paste your verification token (starts with BPC1.) or a signed block (new or legacy).',
      modeNote:'Standard & Seed are detected automatically.',
      placeholder:`BPC1.eyJhZGRyZXNzIjoiMHh...  OR\n\nSigned as: 0x...\nDoc ID: BPC_Terms v1.0 (2025-11-07)\nOrigin: https://blockpilot.co\nPDF: BPC_Terms.pdf\nPDF Hash: 0x...\nTimestamp: 2025-...\nSignature:\n0x...\n\n‚ÄîOR‚Äî\n\nSigned as: 0x... as of 2025-...\nSignature:\n0x...                    ‚Üê legacy v0`,
      verifyBtn:'üîç Verify', signatureOnly:'The signature alone is not enough. Paste the BPC1 token generated after signing.',
      pasteGuidance:'Paste a BPC1 token, a new-format block, or a legacy block.', invalidSig:'‚ùå Error verifying signature'
    },
    fr: {
      title:'V√©rifier la signature', intro:'Collez votre token de v√©rification (commence par BPC1.) ou un bloc sign√© (nouveau ou legacy).',
      modeNote:'Standard & Seed sont d√©tect√©s automatiquement.',
      placeholder:`BPC1.eyJhZGRyZXNzIjoiMHh...  OU\n\nSigned as: 0x...\nDoc ID: BPC_Terms v1.0 (2025-11-07)\nOrigin: https://blockpilot.co\nPDF: BPC_Terms.pdf\nPDF Hash: 0x...\nTimestamp: 2025-...\nSignature:\n0x...\n\n‚ÄîOU‚Äî\n\nSigned as: 0x... as of 2025-...\nSignature:\n0x...                    ‚Üê legacy v0`,
      verifyBtn:'üîç V√©rifier', signatureOnly:'La signature seule ne suffit pas. Collez le token BPC1 g√©n√©r√© apr√®s signature.',
      pasteGuidance:'Collez un token BPC1, un bloc nouveau format ou un bloc legacy.', invalidSig:'‚ùå Erreur lors de la v√©rification'
    }
  };
  const getLang = () => {
    const qs = new URLSearchParams(location.search).get('lang');
    const base = (qs || localStorage.getItem('bp_lang') || 'fr').toLowerCase();
    return base.startsWith('en') ? 'en' : 'fr';
  };
  let lang = getLang();
  const t = (k) => STR[lang]?.[k] || STR.en[k] || k;

  document.addEventListener('DOMContentLoaded', () => {
    lang = getLang();
    renderCopy();
    const params = getHashParams();
    if (params.token) {
      document.getElementById('inputData').value = params.token;
      verify();
    }
  });
  window.addEventListener('storage', (e)=>{
    if (e.key === 'bp_lang') { lang = getLang(); renderCopy(); }
  });
  document.getElementById('verifyBtn').addEventListener('click', verify);

  function getHashParams() {
    const h = (location.hash||'').replace(/^#/,'');
    const o = {};
    h.split('&').forEach(kv => {
      const [k,v] = kv.split('=');
      if (k) o[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
    });
    return o;
  }

  async function verify() {
    const box = document.getElementById('inputData');
    const out = document.getElementById('result');
    const pdfBox = document.getElementById('pdfCheck');
    out.style.display='none'; pdfBox.style.display='none';
    out.className='result'; pdfBox.className='result warn';

    let input = box.value.trim();
    if (!input) return;

    input = input.replace(/\r\n/g, '\n');

    if (input.startsWith('0x') && !input.includes('\n')) {
      out.classList.add('warn'); out.style.display='block';
      out.textContent = t('signatureOnly');
      return;
    }

    try {
      let address, pdf = null, pdfHash = null, timestamp, signature, isLegacy = false, docId = null, origin = null;
      let fromToken = false;

      if (input.startsWith('BPC1.')) {
        fromToken = true;
        const json = decodeURIComponent(escape(atob(input.slice(5))));
        const p = JSON.parse(json);
        address   = p.address;
        pdf       = p.pdf || null;
        pdfHash   = p.pdfHash || null;
        timestamp = p.timestamp;
        signature = p.signature;
        docId     = p.docId || null;
        origin    = p.origin || null;
      } else {
        let m = input.match(
          /Signed as: (0x[a-fA-F0-9]{40})\nDoc ID: (.+?)\nOrigin: (.+?)\nPDF: (.+?)\nPDF Hash: (0x[a-fA-F0-9]{64})\nTimestamp: (.*?)\nSignature:\n(0x[a-fA-F0-9]{130,})/s
        );
        if (m) {
          [, address, docId, origin, pdf, pdfHash, timestamp, signature] = m;
        } else {
          m = input.match(
            /Signed as: (0x[a-fA-F0-9]{40})\nPDF Hash: (0x[a-fA-F0-9]{64})\nTimestamp: (.*?)\nSignature:\n(0x[a-fA-F0-9]{130,})/s
          );
          if (m) {
            [, address, pdfHash, timestamp, signature] = m;
          } else {
            m = input.match(/Signed as: (0x[a-fA-F0-9]{40}) as of (.*?)\s*Signature:\s*(0x[a-fA-F0-9]{130,})/s);
            if (!m) {
              out.classList.add('err'); out.style.display='block';
              out.textContent = t('pasteGuidance'); return;
            }
            [, address, timestamp, signature] = m;
            isLegacy = true;
          }
        }
      }

      const attempts=[];
      const primaryDocId = docId || inferDocId(pdf);
      const safePdf = (p)=> p || PDFs.standard;
      if (fromToken) {
        attempts.push({ pdf: safePdf(pdf), docId, origin });
      } else if (docId || pdf) {
        attempts.push({ pdf: safePdf(pdf), docId: primaryDocId, origin });
      } else {
        attempts.push({ pdf: PDFs.standard, docId: DOC_IDS.standard });
        attempts.push({ pdf: PDFs.seed, docId: DOC_IDS.seed });
      }

      let matched = null;
      for (const attempt of attempts) {
        const usePdf = safePdf(attempt.pdf);
        const useDoc = attempt.docId || inferDocId(usePdf);
        const useOrigin = attempt.origin || origin;
        const message = isLegacy
          ? `I, ${address}, agree to the BPC Terms (see ${usePdf}) as of ${timestamp}`
          : (useDoc && useOrigin)
            ? `I, ${address}, agree to the BPC Terms (${usePdf})
Doc ID: ${useDoc}
Origin: ${useOrigin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`
            : `I, ${address}, agree to the BPC Terms (${usePdf})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

        const recovered = ethers.utils.verifyMessage(message, signature);
        if (recovered?.toLowerCase() === address?.toLowerCase()) {
          matched = { usePdf, useDoc, useOrigin, recovered };
          break;
        }
      }

      if (!matched) {
        out.classList.add('err'); out.style.display='block';
        out.innerHTML = `‚ùå <b>Invalid Signature</b>`;
        return;
      }

      out.classList.add('ok'); out.style.display='block';
      out.innerHTML = `‚úÖ <b>Valid Signature</b><br>
Recovered Address: <code>${matched.recovered}</code><br>
${matched.useDoc ? `Doc ID: <code>${matched.useDoc}</code><br>` : ``}
${matched.useOrigin ? `Origin: <code>${matched.useOrigin}</code><br>` : ``}
PDF: <code>${matched.usePdf}</code><br>` +
      (isLegacy ? `PDF Hash: <i>not present in legacy signature</i><br>` : `PDF Hash: <code>${pdfHash}</code><br>`) +
      `Timestamp: <code>${timestamp}</code>`;

      try {
        const res = await fetch(matched.usePdf, { cache:'no-store' });
        if (res.ok) {
          const buf = new Uint8Array(await res.arrayBuffer());
          const actual = '0x' + keccak256(buf);
          if (!isLegacy && pdfHash && actual.toLowerCase() === pdfHash.toLowerCase()) {
            pdfBox.className='result ok'; pdfBox.innerHTML='üßÆ PDF hash matches on server.';
          } else if (!isLegacy && pdfHash) {
            pdfBox.className='result warn';
            pdfBox.innerHTML = `‚ö†Ô∏è PDF hash mismatch on server.<br>Expected: <code>${pdfHash}</code><br>Server: <code>${actual}</code>`;
          } else {
            pdfBox.className='result ok';
            pdfBox.innerHTML = `‚ÑπÔ∏è Legacy signature: no embedded hash. Current server PDF hash: <code>${actual}</code>`;
          }
          pdfBox.style.display='block';
        }
      } catch (_) {}
    } catch (e) {
      console.error(e);
      out.classList.add('err'); out.style.display='block';
      out.textContent = t('invalidSig');
    }
  }
</script>
</body>
</html>
