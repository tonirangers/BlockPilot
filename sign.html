<!DOCTYPE html>
<html lang="en">
<head>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Terms & Conditions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f9f9f9;display:flex;justify-content:center;align-items:center;padding:40px 20px;margin:0}
    .container{background:#fff;padding:30px;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,.05);max-width:640px;width:100%;text-align:center}
    .logo{height:150px;display:block;margin:0 auto 12px}
    h1{font-size:26px;margin:0 0 10px}
    p{font-size:16px;margin:0 0 20px}

    :root{--blue:#0a6cff;--blueH:#055ad6;--ghost:#eaf2ff}
    .actions{display:flex;flex-direction:column;gap:12px;margin:14px 0}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:700;text-decoration:none;border:0;cursor:pointer}
    .btn-ghost{background:var(--ghost);color:var(--blue)}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blueH)}

    .hash-line{font-size:14px;color:#555;margin:14px 0;word-break:break-word}
    .verify-line{margin:8px 0 16px;color:#333}
    .verify-line a{color:#0a6cff;font-weight:600;text-decoration:none}
    .verify-line a:hover{text-decoration:underline}

    .output-box{background:#eee;padding:16px;border-radius:10px;margin-top:16px;word-break:break-word;text-align:left;overflow-wrap:anywhere}
    .copy-btn{background:#28a745;color:#fff;padding:10px 14px;border:0;border-radius:8px;font-size:14px;margin:6px 6px 0 0;cursor:pointer}
    .copy-btn:hover{background:#1e7e34}
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'">
    <h1>Sign Terms &amp; Conditions</h1>
    <p>By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

    <div class="actions">
      <a class="btn btn-ghost" href="BPC_Terms.pdf" target="_blank">üìÑ View PDF Terms</a>
      <button id="signBtn" class="btn btn-primary">‚úçÔ∏è Sign with Wallet</button>
    </div>

    <div class="hash-line">PDF Hash (Keccak-256): <span id="pdfHash">loading‚Ä¶</span></div>

    <p id="verifyLinkWrap" class="verify-line">
      ‚úÖ You can verify your signature <a id="verifyLink" href="verify.html">here</a> anytime.
    </p>

    <div id="signatureOutput"></div>
  </div>

  <script>
    // --- CONFIG ---
    const pdfPath = 'BPC_Terms.pdf';
    let pdfHash = '';

    // Compute PDF hash (keccak256)
    (async () => {
      try {
        const res = await fetch(pdfPath, { cache: 'no-store' });
        const buf = new Uint8Array(await res.arrayBuffer());
        pdfHash = '0x' + keccak256(buf);
        document.getElementById('pdfHash').textContent = pdfHash;
      } catch (e) {
        console.error('PDF hash error:', e);
        document.getElementById('pdfHash').textContent = '(failed to load hash)';
      }
    })();

    document.getElementById('signBtn').addEventListener('click', signTerms);

    async function signTerms() {
      try {
        if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask)'); return; }
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();

        // wait a bit if hash not ready
        for (let i=0;i<50 && !pdfHash;i++) await new Promise(r=>setTimeout(r,100));
        if (!pdfHash) { alert('PDF hash not ready. Try again.'); return; }

        const timestamp = new Date().toISOString();
        const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

        // sign (fallback to personal_sign if needed)
        let signature;
        try {
          signature = await signer.signMessage(message);
        } catch (e) {
          const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
          signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
        }

        // Legacy block (multi-line)
        const block =
`Signed as: ${address}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

        // JSON payload
        const payload = { address, pdf: pdfPath, pdfHash, timestamp, signature };
        const json = JSON.stringify(payload, null, 2);
        const blob = new Blob([json], { type:'application/json' });
        const jsonUrl = URL.createObjectURL(blob);

        // Compact token
        const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        const verifyUrl = `verify.html#token=${encodeURIComponent(token)}`;

        // Update the persistent link too
        const a = document.getElementById('verifyLink');
        if (a) a.href = verifyUrl;

        // Render output actions
        document.getElementById('signatureOutput').innerHTML = `
          <div class='output-box'>
            ‚úÖ <b>Signed as:</b> ${address}<br>
            üïí <b>Timestamp:</b> ${timestamp}<br>
            üìÑ <b>PDF:</b> ${pdfPath}<br>
            üßÆ <b>PDF Hash:</b> ${pdfHash}<br>
            ‚úçÔ∏è <b>Signature:</b><br>${signature}<br><br>
            <button class='copy-btn' onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)'>üìã Copy block</button>
            <button class='copy-btn' onclick='copyText(\`${token}\`)'>üîë Copy verify token</button>
            <a class='copy-btn' style='display:inline-block;text-decoration:none;text-align:center' href='${jsonUrl}' download='bpc-signature-${address}.json'>‚¨áÔ∏è Download JSON</a>
            <a class='copy-btn' style='display:inline-block;text-decoration:none;text-align:center' href='${verifyUrl}' target='_blank'>üîó Verify via link</a>
          </div>
        `;
      } catch (err) {
        console.error(err);
        alert('Signing cancelled or failed.');
      }
    }

    function copyText(s='') {
      navigator.clipboard.writeText(s);
      alert('Copied!');
    }
  </script>
</body>
</html>
