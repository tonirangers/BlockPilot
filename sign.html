<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Terms & Conditions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9f9f9;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 20px;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
h1 { font-size: 26px; margin-bottom: 10px; }
.logo { height: 42px; margin: 6px auto 18px; display: block; opacity: .9; }
.output-box { overflow-wrap: anywhere; }

      font-size: 26px;
      margin-bottom: 10px;
    }
    p {
      font-size: 16px;
      margin-bottom: 30px;
    }
    a.pdf-button, button.wallet-button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 14px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    a.pdf-button {
      background-color: #e5f0ff;
      color: #007aff;
    }
    button.wallet-button {
      background-color: #007aff;
      color: white;
    }
    button.wallet-button:hover {
      background-color: #005bb5;
    }
    .hash-line {
      font-size: 14px;
      color: #555;
      margin: 20px 0;
      word-break: break-word;
    }
    .output-box {
      background: #eee;
      padding: 16px;
      border-radius: 10px;
      margin-top: 20px;
      word-break: break-word;
      text-align: left;
    }
    .copy-btn {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background-color: #1e7e34;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sign Terms & Conditions</h1>
    <img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'">
    <p>By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>
    <a class="pdf-button" href="BPC_Terms.pdf" target="_blank">üìÑ View PDF Terms</a>
    <button class="wallet-button" onclick="signTerms()">‚úçÔ∏è Sign with Wallet</button>
    <div class="hash-line">
      PDF Hash (Keccak-256): <span id="pdfHash">0xba54d62496e82058eac315cd7ac8d1ad012d718432cd84b65d151507a00cec5b</span>
    </div>
    <div id="signatureOutput"></div>
    <p><a href="verify.html">‚úÖ You can verify your signature here anytime.</a></p>
  </div>

<script>
  // --- CONFIG (standard) ---
  const pdfPath = 'BPC_Terms.pdf'
  let pdfHash = '';

  // Calcul auto du hash (keccak256 via js-sha3 d√©j√† import√©)
  (async () => {
    try {
      const r = await fetch(pdfPath, { cache: 'no-store' });
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      const el = document.getElementById('pdfHash');
      if (el) el.textContent = pdfHash;
    } catch (e) {
      console.error('PDF hash error:', e);
    }
  })();

  // Sign + sortie UX : bloc, JSON, token, lien de v√©rif
  async function signTerms() {
    try {
      if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask)'); return; }
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      // attendre le hash si pas pr√™t
      for (let i=0; i<50 && !pdfHash; i++) await new Promise(r => setTimeout(r,100));
      if (!pdfHash) { alert('PDF hash not ready. Retry in 1s.'); return; }

      const timestamp = new Date().toISOString();
      const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      // signer (fallback personal_sign si besoin)
      let signature;
      try {
        signature = await signer.signMessage(message);
      } catch (e) {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      // Bloc √† copier (legacy)
      const block =
`Signed as: ${address}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      // JSON structur√©
      const payload = { address, pdf: pdfPath, pdfHash, timestamp, signature };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      // Token compact (1 seule valeur √† coller)
      const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const verifyLink = `verify.html#token=${encodeURIComponent(token)}`;

      // UI
      document.getElementById('signatureOutput').innerHTML = `
        <div class='output-box'>
          ‚úÖ <b>Signed as:</b> ${address}<br>
          üïí <b>Timestamp:</b> ${timestamp}<br>
          üìÑ <b>PDF:</b> ${pdfPath}<br>
          üßÆ <b>PDF Hash:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>Signature:</b><br>${signature}<br><br>
          <button class='copy-btn' onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)'>üìã Copy block</button>
          <button class='copy-btn' onclick='copyText(\`${token}\`)'>üîë Copy token</button>
          <a class='copy-btn' style='display:inline-block;text-decoration:none;text-align:center' href='${jsonUrl}' download='bpc-signature-${address}.json'>‚¨áÔ∏è Download JSON</a>
          <a class='copy-btn' style='display:inline-block;text-decoration:none;text-align:center' href='${verifyLink}' target='_blank'>üîó Verify via link</a>
        </div>
      `;
      window.fullSig = block;
      window.bpToken = token;
    } catch (err) {
      console.error(err);
      alert('Signing cancelled or failed.');
    }
  }

  function copyText(s) {
    navigator.clipboard.writeText(s || '');
    alert('Copied!');
  }
</script>


</body>
</html>
