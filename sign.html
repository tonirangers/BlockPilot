<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BPC ‚Äî Sign (Standard & Seed)</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if (EMBED) document.documentElement.classList.add('embed');</script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <style>
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);margin:0;min-height:100vh;display:flex;flex-direction:column;}
    .embed body{background:transparent;}
    .sign-shell{flex:1;display:flex;flex-direction:column;gap:20px;align-items:center;padding:30px 18px 50px;}
    .embed .sign-shell{padding:0;}
    .embed .header{display:none;}
    .embed .sign-logo{display:none;}
    .sign-card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:24px;max-width:760px;width:100%;}
    .embed .sign-card{border:0;box-shadow:none;background:transparent;padding:10px 0 0;}
    .sign-card h1{font-size:26px;margin:0 0 10px;}
    .sign-card p{font-size:16px;margin-bottom:12px;}
    .sign-tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px;}
    .sign-tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:rgba(11,111,102,.08);color:var(--brand);font-weight:800;cursor:pointer;}
    .sign-tab.active{background:var(--brand);color:#fff;border-color:rgba(11,111,102,.55);}
    .sign-row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;}
    .sign-btn{display:flex;align-items:center;justify-content:center;flex:1 1 220px;padding:14px;border-radius:14px;font-weight:900;text-decoration:none;border:1px solid rgba(13,35,31,.14);background:rgba(255,255,255,.9);cursor:pointer;}
    .sign-btn.primary{background:var(--brand);color:#fff;border-color:rgba(11,111,102,.55);}
    .sign-btn.ghost{background:rgba(11,111,102,.08);color:var(--brand);}
    .hash-line{font-size:14px;color:var(--muted);margin:18px 0;word-break:break-word}
    .output-box{background:rgba(238,247,245,.35);padding:16px;border-radius:12px;margin-top:14px;text-align:left;overflow-wrap:anywhere;border:1px solid var(--line)}
    .copy-btn{background:var(--brand);color:#fff;padding:10px 14px;border:0;border-radius:10px;font-size:14px;margin:6px 6px 0 0;cursor:pointer;display:inline-block}
    .copy-btn:hover{background:var(--brand2)}
    .copy-btn.ghost{background:rgba(11,111,102,.08);color:var(--brand);border:1px solid rgba(13,35,31,.14);}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    .muted{color:var(--muted)}
    .actions{margin-top:8px}
    .doc-row{display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px;gap:12px;font-weight:800;}
    .doc-label{font-size:15px;}
    .doc-details{display:none;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(238,247,245,.45);font-size:14px;gap:6px;flex-direction:column;}
    .doc-details.show{display:flex;}
    .token-box{background:rgba(11,111,102,.08);border:1px solid var(--line);padding:12px;border-radius:12px;margin-top:8px;font-size:14px;word-break:break-word;}
    .token-box code{background:rgba(255,255,255,.8);padding:6px;border-radius:8px;display:block;margin:6px 0;}
  </style>

</head>
<body>
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="./fr/" aria-label="BlockPilot">
          <img class="brand__logo" src="logo.png" alt="BlockPilot" />
        </a>
        <div class="nav__links" aria-label="Navigation">
          <a href="./fr/">FR</a>
          <a href="./en/">EN</a>
          <a href="./verify.html">Verify</a>
        </div>
      </nav>
    </div>
  </header>

  <div class="sign-shell">
    <div class="sign-card">
      <div style="text-align:center;">
        <img class="sign-logo" src="logo.png" alt="BPC" style="height:72px;width:72px;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 24px rgba(13,35,31,.08);margin:0 auto 12px;" onerror="this.style.display='none'">
      </div>

      <div class="sign-tabs" role="tablist">
        <span class="sign-tab" id="tab-standard">Standard</span>
        <span class="sign-tab" id="tab-seed">Seed</span>
      </div>

      <h1 id="title">Sign Terms &amp; Conditions</h1>
      <p id="subtitle" class="muted">By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

      <div class="sign-row">
        <a id="viewPdfBtn" class="sign-btn ghost" href="./BPC_Terms.pdf" target="_blank" rel="noopener">üìÑ View PDF Terms</a>
        <button id="signBtn" class="sign-btn primary" disabled>‚è≥ Preparing‚Ä¶</button>
      </div>

      <div class="doc-row">
        <div class="doc-label" id="docLabel">Document : Conditions BPC (PDF)</div>
        <button class="copy-btn ghost" type="button" id="toggleTech">D√©tails techniques</button>
      </div>
      <div class="doc-details" id="techDetails" aria-hidden="true">
        <div><strong>PDF:</strong> <span id="pdfName">BPC_Terms.pdf</span></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;"><strong>Hash (Keccak-256):</strong> <span id="pdfHash">‚Ä¶</span><button class="copy-btn ghost" type="button" id="copyHash">Copier</button></div>
      </div>

      <div class="token-box" id="tokenBox" style="display:none;"></div>

      <div id="signatureOutput"></div>
    </div>
  </div>
<script>
  // ---- Config
  const PDFs = { standard: './BPC_Terms.pdf', seed: './BPC_Terms_Seed.pdf' };
  const TERMS_META = {
    standard: { docId: 'BPC_Terms v1.0 (2025-11-07)' },
    seed:     { docId: 'BPC_Terms_Seed v1.0 (2025-11-07)' }
  };
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzOmjt11dQ3vmYtVrydXl6gejh0lVwqiSxCbXMhUVpQPNBFoMTUP2JJlAj0atjTOcfDtg/exec';

  const STR = {
    en: {
      tabStandard:'Standard', tabSeed:'Seed',
      titleStandard:'Sign Terms & Conditions', titleSeed:'Sign Terms & Conditions (Seed)',
      subtitleStandard:'By signing, you confirm you‚Äôve read and agree to the official BPC Terms.',
      subtitleSeed:'By signing, you confirm you‚Äôve read and agree to the official BPC Seed Terms.',
      viewPdf:'üìÑ View PDF Terms',
      docLabel:'Document: BPC Terms (PDF)',
      techDetails:'Technical details',
      preparing:'‚è≥ Preparing‚Ä¶', signWallet:'‚úçÔ∏è Sign with Wallet', waiting:'üîê Waiting wallet‚Ä¶', signAgain:'‚úçÔ∏è Sign again', hashError:'‚ö†Ô∏è PDF hash error',
      tokenTitle:'Verification token', tokenHint:'Use this token on Verify to confirm your signature.', copyToken:'Copy token',
      signedAs:'Signed as', timestamp:'Timestamp', docId:'Doc ID', origin:'Origin', pdf:'PDF', pdfHash:'PDF Hash', signature:'Signature',
      copyBlock:'Copy block', copyTokenAction:'Copy token', downloadJson:'Download JSON', openVerify:'Open verify',
      shareLink:'Share link', shareToken:'Share token', shareJson:'Share JSON', copyMsg:'Copied!',
      alertMissingWallet:'Wallet not detected (Rabby/MetaMask/Zeal)', signFailed:'Signing cancelled or failed.'
    },
    fr: {
      tabStandard:'Standard', tabSeed:'Seed',
      titleStandard:'Signer les Conditions', titleSeed:'Signer les Conditions (Seed)',
      subtitleStandard:'En signant, vous confirmez avoir lu et accept√© les Conditions BPC.',
      subtitleSeed:'En signant, vous confirmez avoir lu et accept√© les Conditions BPC Seed.',
      viewPdf:'üìÑ Voir le PDF',
      docLabel:'Document : Conditions BPC (PDF)',
      techDetails:'D√©tails techniques',
      preparing:'‚è≥ Pr√©paration‚Ä¶', signWallet:'‚úçÔ∏è Signer avec le wallet', waiting:'üîê En attente du wallet‚Ä¶', signAgain:'‚úçÔ∏è Signer √† nouveau', hashError:'‚ö†Ô∏è Erreur de hash PDF',
      tokenTitle:'Token de v√©rification', tokenHint:'Collez ce token dans V√©rifier pour valider votre signature.', copyToken:'Copier le token',
      signedAs:'Sign√© en tant que', timestamp:'Horodatage', docId:'Doc ID', origin:'Origine', pdf:'PDF', pdfHash:'Hash PDF', signature:'Signature',
      copyBlock:'Copier le bloc', copyTokenAction:'Copier le token', downloadJson:'T√©l√©charger le JSON', openVerify:'Ouvrir V√©rifier',
      shareLink:'Partager le lien', shareToken:'Partager le token', shareJson:'Partager le JSON', copyMsg:'Copi√© !',
      alertMissingWallet:'Wallet non d√©tect√© (Rabby/MetaMask/Zeal)', signFailed:'Signature annul√©e ou √©chou√©e.'
    }
  };
  const getLang = () => ((localStorage.getItem('bp_lang')||document.documentElement.lang||'en').startsWith('fr') ? 'fr' : 'en');
  let lang = getLang();
  const t = (k) => STR[lang]?.[k] || STR.en[k] || k;

  // ---- State
  let mode = 'standard';
  let pdfPath = PDFs[mode];
  let pdfHash = '';
  let signing = false;

  function setButtonLabel(state){
    const btn=document.getElementById('signBtn');
    if (!btn) return;
    const labelMap={
      preparing:t('preparing'), ready:t('signWallet'), waiting:t('waiting'), again:t('signAgain'), error:t('hashError')
    };
    btn.textContent = labelMap[state] || t('signWallet');
  }

  function renderCopy(){
    document.documentElement.lang = lang;
    const tabStd=document.getElementById('tab-standard');
    const tabSeed=document.getElementById('tab-seed');
    if (tabStd) tabStd.textContent=t('tabStandard');
    if (tabSeed) tabSeed.textContent=t('tabSeed');
    document.getElementById('viewPdfBtn').textContent = t('viewPdf');
    const docLabel=document.getElementById('docLabel');
    if (docLabel) docLabel.textContent = t('docLabel');
    const techBtn=document.getElementById('toggleTech');
    if (techBtn) techBtn.textContent = t('techDetails');
    const copyHashBtn=document.getElementById('copyHash');
    if (copyHashBtn) copyHashBtn.textContent = t('copyTokenAction');
    const tokenBox=document.getElementById('tokenBox');
    if (tokenBox && tokenBox.dataset.token){
      tokenBox.innerHTML = `<strong>${t('tokenTitle')}</strong><code>${tokenBox.dataset.token}</code><button class="copy-btn" type="button" onclick="copyText('${tokenBox.dataset.token}')">${t('copyToken')}</button><div class="small">${t('tokenHint')}</div>`;
    }
    const btn=document.getElementById('signBtn');
    if (btn && btn.disabled) setButtonLabel(signing ? 'waiting' : 'preparing');
  }

  function updateHeadings(){
    document.getElementById('title').textContent = mode==='standard' ? t('titleStandard') : t('titleSeed');
    document.getElementById('subtitle').textContent = mode==='standard' ? t('subtitleStandard') : t('subtitleSeed');
  }

  // ---- Init
  document.addEventListener('DOMContentLoaded', () => {
    lang = getLang();
    renderCopy();
    const params = getHashParams();
    if (params.mode === 'seed') mode = 'seed';
    updateHeadings();
    applyMode();
    const techBtn=document.getElementById('toggleTech');
    const techDetails=document.getElementById('techDetails');
    if (techBtn && techDetails) techBtn.addEventListener('click', ()=>{
      const show=!techDetails.classList.contains('show');
      techDetails.classList.toggle('show', show);
      techDetails.setAttribute('aria-hidden', show ? 'false' : 'true');
    });
  });

  window.addEventListener('storage', (e)=>{
    if (e.key === 'bp_lang') {
      lang = getLang();
      renderCopy();
      updateHeadings();
    }
  });

  document.getElementById('tab-standard').addEventListener('click', () => { mode='standard'; updateHeadings(); applyMode(true); });
  document.getElementById('tab-seed').addEventListener('click', () => { mode='seed'; updateHeadings(); applyMode(true); });
  document.getElementById('signBtn').addEventListener('click', signTerms);
  const copyHashBtn=document.getElementById('copyHash');
  if (copyHashBtn) copyHashBtn.addEventListener('click', () => copyText(pdfHash || document.getElementById('pdfHash')?.textContent || ''));

  function getHashParams() {
    const h = (location.hash||'').replace(/^#/,'');
    const o = {};
    h.split('&').forEach(kv => {
      const [k,v] = kv.split('=');
      if (k) o[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
    });
    return o;
  }

  async function applyMode(pushHash=false) {
    pdfPath = PDFs[mode];
    // tabs
    document.getElementById('tab-standard').classList.toggle('active', mode==='standard');
    document.getElementById('tab-seed').classList.toggle('active', mode==='seed');
    // titles
    updateHeadings();
    // links
    document.getElementById('viewPdfBtn').href = pdfPath;
    document.getElementById('pdfName').textContent = pdfPath;
    const tokenBox=document.getElementById('tokenBox');
    if (tokenBox){ tokenBox.style.display='none'; tokenBox.dataset.token=''; tokenBox.innerHTML=''; }

    // clear previous receipt
    document.getElementById('signatureOutput').innerHTML = '';

    // disable button while hashing
    const btn = document.getElementById('signBtn');
    signing = false;
    btn.disabled = true; setButtonLabel('preparing');

    // compute hash
    pdfHash = '';
    document.getElementById('pdfHash').textContent = '‚Ä¶';
    try {
      const r = await fetch(pdfPath + '?v=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Fetch PDF failed: ' + r.status);
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
      btn.disabled = false; setButtonLabel('ready');
    } catch(e){
      console.error('PDF hash error:', e);
      btn.disabled = true; setButtonLabel('error');
    }

    if (pushHash) location.hash = `mode=${mode}`;
    renderCopy();
  }

  async function signTerms() {
    if (signing) return;
    const btn = document.getElementById('signBtn');
    try {
      if (!window.ethereum) { alert(t('alertMissingWallet')); return; }
      signing = true; btn.disabled = true; setButtonLabel('waiting');

      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      for (let i=0;i<50 && !pdfHash;i++) await new Promise(r=>setTimeout(r,100));
      if (!pdfHash) { alert('PDF hash not ready yet. Please retry in 1s.'); signing = false; btn.disabled=false; btn.textContent='‚úçÔ∏è Sign with Wallet'; return; }

      const timestamp = new Date().toISOString();
      const origin = location.origin;
      const docId = TERMS_META[mode].docId;

      const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      let signature;
      try { signature = await signer.signMessage(message); }
      catch {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      const block =
`Signed as: ${address}
Doc ID: ${docId}
Origin: ${origin}
PDF: ${pdfPath}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      const payload = { mode, address, pdf: pdfPath, pdfHash, timestamp, signature, origin, docId, userAgent: navigator.userAgent };
      const token   = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const verifyUrl = new URL('verify.html', location.href).toString();
      const verifyLink = `${verifyUrl}#mode=${mode}&token=${encodeURIComponent(token)}`;

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      // Log to Google Sheets (best-effort)
      if (WEBHOOK_URL) {
        try {
          await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
        } catch (e) { /* silencieux */ }
      }

      // Render receipt
      const tokenBox=document.getElementById('tokenBox');
      if (tokenBox){
        tokenBox.dataset.token = token;
        tokenBox.style.display='block';
        tokenBox.innerHTML = `<strong>${t('tokenTitle')}</strong><code>${token}</code><button class="copy-btn" type="button" onclick="copyText('${token}')">${t('copyToken')}</button><div class="small">${t('tokenHint')}</div>`;
      }

      document.getElementById('signatureOutput').innerHTML = `
        <div class="output-box">
          ‚úÖ <b>${t('signedAs')}:</b> ${address} <span class="muted">[${mode}]</span><br>
          üïí <b>${t('timestamp')}:</b> ${timestamp}<br>
          üìÑ <b>${t('docId')}:</b> ${docId}<br>
          üåê <b>${t('origin')}:</b> ${origin}<br>
          üìò <b>${t('pdf')}:</b> ${pdfPath}<br>
          üßÆ <b>${t('pdfHash')}:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>${t('signature')}:</b><br>${signature}<br><br>

          <div class="actions">
            <button class="copy-btn" onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)' title="${t('copyBlock')}">üìã ${t('copyBlock')}</button>
            <button class="copy-btn" onclick='copyText(\`${token}\`)' title="${t('copyTokenAction')}">üîë ${t('copyTokenAction')}</button>
            <a class="copy-btn" href="${jsonUrl}" download="bpc-signature-${address}.json" title="${t('downloadJson')}">‚¨áÔ∏è ${t('downloadJson')}</a>
            <a class="copy-btn" href="${verifyLink}" target="_blank" rel="noopener" title="${t('openVerify')}">üîó ${t('openVerify')}</a>
          </div>

          <div class="actions">
            <button class="copy-btn" onclick='shareLink("${verifyLink}")'>üì§ ${t('shareLink')}</button>
            <button class="copy-btn" onclick='shareToken("${token}")'>üîë ${t('shareToken')}</button>
            <button class="copy-btn" onclick='shareJsonFile("bpc-signature-${address}.json", \`${json.replace(/`/g,"\\`")}\`)'>üßæ ${t('shareJson')}</button>
          </div>
        </div>
      `;

      // reset button
      signing = false; btn.disabled = false; setButtonLabel('again');
    } catch (err) {
      console.error(err);
      signing = false;
      btn.disabled = false; setButtonLabel('ready');
      alert(t('signFailed'));
    }
  }

  function copyText(s){ navigator.clipboard.writeText(s||''); alert(t('copyMsg')); }

  // --- Share helpers (Web Share API + fallbacks)
  async function shareLink(url){
    try{
      if(navigator.share){ await navigator.share({title:'BPC ‚Äî Verify',text:'V√©rifier ma signature BPC :',url}); }
      else { await navigator.clipboard.writeText(url); alert('Link copied!'); }
    }catch(_){}
  }
  async function shareToken(token){
    const text = `BPC verify token:\n${token}`;
    try{
      if(navigator.share){ await navigator.share({title:'BPC ‚Äî Token',text}); }
      else { await navigator.clipboard.writeText(text); alert('Token copied!'); }
    }catch(_){}
  }
  async function shareJsonFile(filename, jsonStr){
    try{
      const file = new File([jsonStr], filename, {type:'application/json'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({ title:'BPC ‚Äî JSON Receipt', files:[file] });
      }else{
        // fallback: t√©l√©chargement direct
        const blob = new Blob([jsonStr], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), {href:url, download:filename});
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
    }catch(_){}
  }
</script>
</body>
</html>
