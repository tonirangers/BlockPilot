<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlockPilot - Sign</title>
  <link rel="stylesheet" href="assets/styles.css" />
  
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if (EMBED) document.documentElement.classList.add('embed');</script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    /* Reset & Base adapt√©e pour iframe */
    body { background: #fff; margin: 0; padding: 24px; font-family: 'Inter', sans-serif; color: #0F172A; }
    .embed body { background: transparent; padding: 0; }
    
    .sign-container { max-width: 600px; margin: 0 auto; }
    .embed .sign-container { max-width: 100%; margin: 0; }

    /* Header interne (cach√© en embed) */
    .header-internal { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #E2E8F0; }
    .embed .header-internal { display: none; }

    /* Titres */
    h1 { font-size: 1.5rem; font-weight: 700; margin: 0 0 8px; color: #3C756E; }
    p.subtitle { color: #64748B; margin: 0 0 24px; font-size: 0.95rem; }

    /* Tabs (Standard / Seed) */
    .sign-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .sign-tab {
      padding: 8px 16px; border-radius: 99px; border: 1px solid #E2E8F0;
      background: #fff; color: #64748B; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .sign-tab.active { background: rgba(60, 117, 110, 0.1); color: #3C756E; border-color: transparent; }

    /* Boutons & Actions */
    .action-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin-bottom: 24px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; width: 100%;
      padding: 12px; border-radius: 99px; font-weight: 600; cursor: pointer; border: none; font-size: 1rem;
    }
    .btn-primary { background: #3C756E; color: white; }
    .btn-primary:hover { background: #2E5C56; }
    .btn-ghost { background: #F8FAFC; color: #3C756E; border: 1px solid #E2E8F0; }
    .btn:disabled { opacity: 0.6; cursor: wait; }

    /* Details Techniques */
    .tech-box { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; padding: 16px; font-size: 0.85rem; margin-top: 24px; }
    .tech-header { display: flex; justify-content: space-between; cursor: pointer; font-weight: 600; color: #64748B; }
    .tech-content { display: none; margin-top: 12px; word-break: break-all; }
    .tech-content.show { display: block; }
    
    /* Output Signature */
    .output-box { background: #ECFDF5; border: 1px solid #A7F3D0; border-radius: 12px; padding: 16px; margin-top: 24px; }
    .output-box pre { white-space: pre-wrap; word-break: break-all; font-family: monospace; font-size: 0.85rem; color: #064E3B; }

    /* Token Box */
    .token-box { background: rgba(60, 117, 110, 0.05); border: 1px solid #E2E8F0; padding: 16px; border-radius: 12px; margin-top: 16px; display: none; }
    .token-code { background: #fff; padding: 8px; border-radius: 6px; font-family: monospace; word-break: break-all; margin: 8px 0; border: 1px solid #E2E8F0; }
    
    .copy-btn { background: #3C756E; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-right: 8px; margin-top: 8px; }

    /* Responsive */
    @media (max-width: 500px) { .action-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <div class="header-internal">
    <img src="logo.png" alt="BPC" height="40">
    <nav style="display:flex; gap:12px; font-size:14px; font-weight:600;">
      <a href="?lang=fr" style="text-decoration:none; color:#3C756E;">FR</a>
      <a href="?lang=en" style="text-decoration:none; color:#64748B;">EN</a>
    </nav>
  </div>

  <div class="sign-container">
    
    <div class="sign-tabs">
      <div id="tab-standard" class="sign-tab active">Standard</div>
      <div id="tab-seed" class="sign-tab">Seed</div>
    </div>

    <h1 id="title">Sign Terms & Conditions</h1>
    <p id="subtitle" class="subtitle">By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

    <div class="action-row">
      <a id="viewPdfBtn" class="btn btn-ghost" href="./BPC_Terms.pdf" target="_blank">üìÑ PDF</a>
      <button id="signBtn" class="btn btn-primary" disabled>‚è≥ Preparing...</button>
    </div>
    
    <p id="signNote" style="font-size:0.8rem; color:#64748B; text-align:center;">
      Off-chain signature (0 gas). No transaction sent.
    </p>

    <div class="tech-box">
      <div class="tech-header" id="toggleTech">
        <span id="docLabel">Document Info</span>
        <span>‚ñº</span>
      </div>
      <div class="tech-content" id="techDetails">
        <div style="margin-bottom:8px;"><strong>PDF Hash (Keccak256):</strong></div>
        <div id="pdfHash" style="font-family:monospace; color:#3C756E;">...</div>
        <div style="margin-top:8px;"><strong>File:</strong> <span id="pdfName">BPC_Terms.pdf</span></div>
      </div>
    </div>

    <div id="tokenBox" class="token-box"></div>
    <div id="signatureOutput"></div>

  </div>

<script>
  // CONFIG & LIENS
  const PDFs = { standard: './BPC_Terms.pdf', seed: './BPC_Terms_Seed.pdf' };
  const TERMS_META = {
    standard: { docId: 'BPC_Terms v1.0 (2025-11-07)' },
    seed:     { docId: 'BPC_Terms_Seed v1.0 (2025-11-07)' }
  };
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxEr5Wky-9oz2H7QMaWvc0Xi7-u1hEm1Et-ZtKoPyek4Gp2tXH2FN3sx_ys1JqPtRPTLw/exec';

  // TRADUCTIONS
  const STR = {
    en: {
      titleStd: 'Sign Terms', titleSeed: 'Sign Seed Terms',
      subStd: 'Confirm you agree to the official BPC Terms.', subSeed: 'Confirm you agree to the BPC Seed Terms.',
      viewPdf: 'üìÑ View PDF', signBtn: '‚úçÔ∏è Sign with Wallet', preparing: '‚è≥ Preparing...',
      docLabel: 'Technical Details (Hash)', tokenTitle: 'Verification Token',
      signed: '‚úÖ Signed Successfully!', copyToken: 'Copy Token', download: 'Download JSON'
    },
    fr: {
      titleStd: 'Signer les Conditions', titleSeed: 'Signer Conditions Seed',
      subStd: 'Confirmez votre accord avec les Conditions BPC.', subSeed: 'Confirmez votre accord avec les Conditions Seed.',
      viewPdf: 'üìÑ Voir PDF', signBtn: '‚úçÔ∏è Signer avec Wallet', preparing: '‚è≥ Pr√©paration...',
      docLabel: 'D√©tails Techniques (Hash)', tokenTitle: 'Token de V√©rification',
      signed: '‚úÖ Signature R√©ussie !', copyToken: 'Copier Token', download: 'T√©l√©charger JSON'
    }
  };

  // LANGUE
  const getLang = () => {
    const qs = new URLSearchParams(location.search).get('lang');
    return (qs || localStorage.getItem('bp_lang') || 'fr').startsWith('en') ? 'en' : 'fr';
  };
  let lang = getLang();
  const t = (k) => STR[lang][k] || STR.en[k];

  // ETAT
  let mode = 'standard';
  let pdfPath = PDFs[mode];
  let pdfHash = '';
  let signing = false;

  // UI UPDATE
  function updateUI() {
    document.getElementById('tab-standard').classList.toggle('active', mode==='standard');
    document.getElementById('tab-seed').classList.toggle('active', mode==='seed');
    
    document.getElementById('title').textContent = mode==='standard' ? t('titleStd') : t('titleSeed');
    document.getElementById('subtitle').textContent = mode==='standard' ? t('subStd') : t('subSeed');
    document.getElementById('viewPdfBtn').textContent = t('viewPdf');
    document.getElementById('viewPdfBtn').href = pdfPath;
    document.getElementById('pdfName').textContent = pdfPath;
    document.getElementById('docLabel').textContent = t('docLabel');
    
    const btn = document.getElementById('signBtn');
    if(!signing && pdfHash) btn.textContent = t('signBtn');
  }

  // LOGIQUE HASH & SIGN
  async function loadMode(m) {
    mode = m; pdfPath = PDFs[mode];
    updateUI();
    
    const btn = document.getElementById('signBtn');
    btn.disabled = true; btn.textContent = t('preparing');
    document.getElementById('pdfHash').textContent = '...';
    
    try {
      const r = await fetch(pdfPath + '?v=' + Date.now());
      if(!r.ok) throw new Error('PDF Error');
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
      btn.disabled = false;
      updateUI();
    } catch(e) {
      console.error(e);
      btn.textContent = "‚ö†Ô∏è Error loading PDF";
    }
  }

  async function sign() {
    if(signing) return;
    const btn = document.getElementById('signBtn');
    
    try {
      if(!window.ethereum) return alert("Wallet not detected (MetaMask/Rabby).");
      
      signing = true; btn.disabled = true; btn.textContent = "üîê Connect Wallet...";
      
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();
      
      btn.textContent = "‚úçÔ∏è Check Wallet...";
      
      const timestamp = new Date().toISOString();
      const origin = location.origin;
      const docId = TERMS_META[mode].docId;

      const message = 
`I, ${address}, agree to the BPC Terms (${pdfPath})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      let signature;
      try { signature = await signer.signMessage(message); }
      catch {
        // Fallback personal_sign
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      // Generation du Token
      const payload = { mode, address, pdf: pdfPath, pdfHash, timestamp, signature, origin, docId };
      const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      // Webhook (Fire & Forget)
      fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(()=>{});

      // Affichage R√©sultat
      const box = document.getElementById('tokenBox');
      box.style.display = 'block';
      box.innerHTML = `
        <div style="font-weight:700; color:#3C756E; margin-bottom:8px;">${t('signed')}</div>
        <div class="token-code">${token}</div>
        <button class="copy-btn" onclick="navigator.clipboard.writeText('${token}');alert('Copied!')">${t('copyToken')}</button>
        <a class="copy-btn" href="${jsonUrl}" download="bpc-sig-${address}.json" style="text-decoration:none;">${t('download')}</a>
      `;

      btn.textContent = t('signBtn');
      signing = false; btn.disabled = false;

    } catch(e) {
      console.error(e);
      alert("Sign failed or cancelled.");
      signing = false; btn.disabled = false; updateUI();
    }
  }

  // INIT
  document.addEventListener('DOMContentLoaded', () => {
    // Gestion Tabs
    document.getElementById('tab-standard').onclick = () => loadMode('standard');
    document.getElementById('tab-seed').onclick = () => loadMode('seed');
    
    // Toggle Tech Details
    document.getElementById('toggleTech').onclick = () => {
      document.getElementById('techDetails').classList.toggle('show');
    };

    // Bouton Signer
    document.getElementById('signBtn').onclick = sign;

    // Load initial
    loadMode('standard');
  });

</script>
</body>
</html>
