<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BPC ‚Äî Verify (Standard & Seed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if (EMBED) document.documentElement.classList.add('embed');</script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f4f4f4;margin:0;padding:40px 20px;display:flex;align-items:center;justify-content:center}
    .embed body{background:transparent;padding:10px 0;}
    .container{max-width:680px;width:100%;background:#fff;padding:30px;border-radius:16px;box-shadow:0 0 12px rgba(0,0,0,.05);text-align:center}
    .embed .container{box-shadow:0 10px 24px rgba(13,35,31,.08);border:1px solid #d9ebe7;border-radius:18px;}
    .logo{height:150px;display:block;margin:0 auto 12px}
    .tabs{display:flex;gap:8px;justify-content:center;margin:8px 0 16px}
    .tab{padding:8px 12px;border-radius:999px;background:#eaf2ff;color:#0a6cff;text-decoration:none;font-weight:600;cursor:pointer;user-select:none}
    .tab.active{background:#0a6cff;color:#fff}
    h2{font-size:26px;margin:0 0 10px}
    p{font-size:16px;margin:0 0 14px}
    :root{--blue:#0a6cff;--blueH:#055ad6}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:700;text-decoration:none;border:0;cursor:pointer;background:var(--blue);color:#fff}
    .btn:hover{background:var(--blueH)}
    textarea{width:100%;padding:12px;font-family:monospace;font-size:14px;border-radius:8px;border:1px solid #ccc;resize:vertical;min-height:120px;margin:10px 0 16px}
    .result{margin-top:16px;padding:16px;border-radius:10px;font-size:14px;text-align:left;word-break:break-word;overflow-wrap:anywhere}
    .ok{background:#d4edda;color:#155724}
    .err{background:#f8d7da;color:#721c24}
    .warn{background:#fff3cd;color:#856404}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" aria-label="Home"><img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'"></a>

    <nav class="tabs">
      <span class="tab" id="tab-standard">Standard</span>
      <span class="tab" id="tab-seed">Seed</span>
    </nav>

    <h2>Verify Signature</h2>
    <p class="muted">Paste your <b>verify token</b> (starts with <code>BPC1.</code>) or a full block (new or legacy).</p>

    <textarea id="inputData" placeholder="BPC1.eyJhZGRyZXNzIjoiMHh...  OR

Signed as: 0x...
Doc ID: BPC_Terms v1.0 (2025-11-07)
Origin: https://yourdomain.tld
PDF: BPC_Terms.pdf
PDF Hash: 0x...
Timestamp: 2025-...
Signature:
0x...

‚ÄîOR‚Äî

Signed as: 0x... as of 2025-...
Signature:
0x...                    ‚Üê legacy v0"></textarea>

    <button class="btn" id="verifyBtn">üîç Verify</button>

    <div id="result" class="result" style="display:none"></div>
    <div id="pdfCheck" class="result warn" style="display:none"></div>
  </div>

<script>
  const PDFs = { standard: 'BPC_Terms.pdf', seed: 'BPC_Terms_Seed.pdf' };
  let mode = 'standard';
  let defaultPdf = PDFs[mode];

  document.addEventListener('DOMContentLoaded', () => {
    const params = getHashParams();
    if (params.mode === 'seed') setMode('seed', false);
    if (params.token) {
      document.getElementById('inputData').value = params.token;
      verify();
    }
  });
  document.getElementById('tab-standard').addEventListener('click', () => setMode('standard', true));
  document.getElementById('tab-seed').addEventListener('click', () => setMode('seed', true));
  document.getElementById('verifyBtn').addEventListener('click', verify);

  function getHashParams() {
    const h = (location.hash||'').replace(/^#/,'');
    const o = {};
    h.split('&').forEach(kv => {
      const [k,v] = kv.split('=');
      if (k) o[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
    });
    return o;
  }
  function setMode(m, pushHash){
    mode = m; defaultPdf = PDFs[mode];
    document.getElementById('tab-standard').classList.toggle('active', mode==='standard');
    document.getElementById('tab-seed').classList.toggle('active', mode==='seed');
    if (pushHash) location.hash = `mode=${mode}`;
  }

  async function verify() {
    const box = document.getElementById('inputData');
    const out = document.getElementById('result');
    const pdfBox = document.getElementById('pdfCheck');
    out.style.display='none'; pdfBox.style.display='none';
    out.className='result'; pdfBox.className='result warn';

    let input = box.value.trim();
    if (!input) return;

    // normalize CRLF ‚Üí LF (Windows paste friendly)
    input = input.replace(/\r\n/g, '\n');

    try {
      let address, pdf = defaultPdf, pdfHash = null, timestamp, signature, isLegacy = false, docId = null, origin = null;

      if (input.startsWith('BPC1.')) {
        // token mode
        const json = decodeURIComponent(escape(atob(input.slice(5))));
        const p = JSON.parse(json);
        address   = p.address;
        pdf       = p.pdf || defaultPdf;
        pdfHash   = p.pdfHash || null;
        timestamp = p.timestamp;
        signature = p.signature;
        docId     = p.docId || null;
        origin    = p.origin || null;
      } else {
        // v1 block (with Doc ID & Origin)
        let m = input.match(
          /Signed as: (0x[a-fA-F0-9]{40})\nDoc ID: (.+?)\nOrigin: (.+?)\nPDF: (.+?)\nPDF Hash: (0x[a-fA-F0-9]{64})\nTimestamp: (.*?)\nSignature:\n(0x[a-fA-F0-9]{130,})/s
        );
        if (m) {
          [, address, docId, origin, pdf, pdfHash, timestamp, signature] = m;
        } else {
          // new block (sans docId/origin, g√©n√©ration pr√©c√©dente)
          m = input.match(
            /Signed as: (0x[a-fA-F0-9]{40})\nPDF Hash: (0x[a-fA-F0-9]{64})\nTimestamp: (.*?)\nSignature:\n(0x[a-fA-F0-9]{130,})/s
          );
          if (m) {
            [, address, pdfHash, timestamp, signature] = m;
            // pdf = defaultPdf
          } else {
            // legacy v0 (pas de hash, pas de pdf)
            m = input.match(/Signed as: (0x[a-fA-F0-9]{40}) as of (.*?)\s*Signature:\s*(0x[a-fA-F0-9]{130,})/s);
            if (!m) {
              out.classList.add('err'); out.style.display='block';
              out.textContent = '‚ö†Ô∏è Paste a BPC1 token, a new-format block, or a legacy block.'; return;
            }
            [, address, timestamp, signature] = m;
            isLegacy = true;
          }
        }
      }

      // Rebuild exact message
      const message = isLegacy
        ? `I, ${address}, agree to the BPC Terms (see ${pdf}) as of ${timestamp}`
        : (docId && origin)
          ? `I, ${address}, agree to the BPC Terms (${pdf})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`
          : `I, ${address}, agree to the BPC Terms (${pdf})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      const recovered = ethers.utils.verifyMessage(message, signature);

      if (recovered.toLowerCase() === address.toLowerCase()) {
        out.classList.add('ok'); out.style.display='block';
        out.innerHTML = `‚úÖ <b>Valid Signature</b><br>
Recovered Address: <code>${recovered}</code><br>
${docId ? `Doc ID: <code>${docId}</code><br>` : ``}
${origin ? `Origin: <code>${origin}</code><br>` : ``}
PDF: <code>${pdf}</code><br>` +
(isLegacy ? `PDF Hash: <i>not present in legacy signature</i><br>` : `PDF Hash: <code>${pdfHash}</code><br>`) +
`Timestamp: <code>${timestamp}</code>`;
      } else {
        out.classList.add('err'); out.style.display='block';
        out.innerHTML = `‚ùå <b>Invalid Signature</b><br>Recovered Address: <code>${recovered}</code>`;
        return;
      }

      // Optional: compare current server PDF hash
      try {
        const res = await fetch(pdf, { cache:'no-store' });
        if (res.ok) {
          const buf = new Uint8Array(await res.arrayBuffer());
          const actual = '0x' + keccak256(buf);
          if (!isLegacy && pdfHash && actual.toLowerCase() === pdfHash.toLowerCase()) {
            pdfBox.className='result ok'; pdfBox.innerHTML='üßÆ PDF hash matches on server.'; 
          } else if (!isLegacy && pdfHash) {
            pdfBox.className='result warn';
            pdfBox.innerHTML = `‚ö†Ô∏è PDF hash mismatch on server.<br>Expected: <code>${pdfHash}</code><br>Server: <code>${actual}</code>`;
          } else {
            pdfBox.className='result ok';
            pdfBox.innerHTML = `‚ÑπÔ∏è Legacy signature: no embedded hash. Current server PDF hash: <code>${actual}</code>`;
          }
          pdfBox.style.display='block';
        }
      } catch (_) {}
    } catch (e) {
      console.error(e);
      out.classList.add('err'); out.style.display='block';
      out.textContent = '‚ùå Error verifying signature';
    }
  }
</script>
</body>
</html>
