<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlockPilot ‚Äî Signature & V√©rification</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    .sig-section { display: none; }
    .sig-section.active { display: block; animation: fadeIn 0.3s ease; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Style des onglets mode Standard/Seed (interne √† la zone de signature) */
    .mode-tabs { display: flex; gap: 8px; margin-bottom: 24px; background: var(--bp-surface-alt); padding: 4px; border-radius: 99px; width: fit-content; border: 1px solid var(--bp-border); }
    .mode-tab { padding: 6px 16px; border-radius: 99px; font-weight: 600; font-size: 13px; cursor: pointer; color: var(--bp-text-muted); transition: 0.2s; }
    .mode-tab.active { background: #fff; color: var(--bp-primary); box-shadow: var(--bp-shadow-card); }

    /* Zone de r√©sultat (Token BPC1) */
    .result-card { background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 12px; padding: 20px; margin-top: 24px; }
    .token-display { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid var(--bp-border); font-family: monospace; font-size: 12px; word-break: break-all; margin: 12px 0; }
    
    /* Zone de v√©rification */
    .verify-area { width: 100%; height: 150px; margin-bottom: 16px; }
  </style>
</head>
<body data-lang="fr">
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="../fr/#overview"><img class="brand__logo" src="../logo.png" alt="BlockPilot" /></a>
        <div class="navSearch"><span>Rechercher...</span><kbd>‚åòK</kbd></div>
        <button class="navToggle" id="navToggle">Menu</button>
        <div class="nav__links">
          <a href="../fr/#performance">Performance</a>
          <a href="../fr/#security">S√©curit√©</a>
          <a href="#docs" style="opacity:0.5;">Docs</a>
          <a href="./signature.html" class="active">Signature</a>
        </div>
        <div class="lang">
          <a class="pill is-active" href="../fr/signature.html">FR</a>
          <a class="pill" href="../en/signature.html">EN</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 class="h1">Signature & V√©rification</h1>
      <p class="p">Signez vos documents officiels ou v√©rifiez l'authenticit√© d'un token BPC.</p>

      <div class="scenarioChips" style="margin-bottom: 32px;">
        <button class="chip active" onclick="switchMainView('sign', this)">Signer un document</button>
        <button class="chip" onclick="switchMainView('verify', this)">V√©rifier un token</button>
      </div>

      <div class="bp-card">
        
        <div id="view-sign" class="sig-section active">
          <div class="mode-tabs">
            <div class="mode-tab active" onclick="switchMode('standard', this)">Standard</div>
            <div class="mode-tab" onclick="switchMode('seed', this)">Seed</div>
          </div>

          <h2 class="cardTitle" id="sign-title">Signer les Conditions BPC</h2>
          <p class="cardSub" id="sign-sub">En signant, vous confirmez avoir lu et accept√© les conditions officielles.</p>

          <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin: 24px 0;">
            <a id="pdfLink" href="../BPC_Terms.pdf" target="_blank" class="btn btn--ghost">üìÑ Voir le PDF</a>
            <button id="signBtn" class="btn btn--primary" onclick="processSignature()">‚úçÔ∏è Signer avec le Wallet</button>
          </div>

          <div id="tokenResult" class="result-card" style="display:none;">
            <strong style="color:#166534;">‚úÖ Signature r√©ussie !</strong>
            <div class="token-display" id="tokenValue"></div>
            <button class="btn btn--primary" style="font-size:12px; padding:6px 12px;" onclick="copyToken()">Copier le token</button>
          </div>

          <div class="mini" style="margin-top:24px;">
            <strong>D√©tails techniques (Hash)</strong>
            <code id="pdfHashDisplay" style="font-size:11px; color:var(--bp-primary);">Calcul du hash en cours...</code>
          </div>
        </div>

        <div id="view-verify" class="sig-section">
          <h2 class="cardTitle">V√©rifier un Token BPC1</h2>
          <p class="cardSub">Collez le token re√ßu pour valider l'identit√© du signataire et l'int√©grit√© du document.</p>
          
          <textarea id="verifyInput" class="input verify-area" placeholder="BPC1.eyJhZGRyZXNzIjoiMHg..."></textarea>
          <button class="btn btn--primary" onclick="processVerification()">üîç V√©rifier maintenant</button>

          <div id="verifyResult" class="result-card" style="display:none; background:#F8FAFC; border-color:var(--bp-border);">
            <div id="verifyContent" style="font-size:14px; color:var(--bp-text-main);"></div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script>
    // --- CONFIG & DATA ---
    const PDFs = { standard: '../BPC_Terms.pdf', seed: '../BPC_Terms_Seed.pdf' };
    const DOC_IDS = { standard: 'BPC_Terms v1.0', seed: 'BPC_Terms_Seed v1.0' };
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxEr5Wky-9oz2H7QMaWvc0Xi7-u1hEm1Et-ZtKoPyek4Gp2tXH2FN3sx_ys1JqPtRPTLw/exec';

    let currentMode = 'standard';
    let currentHash = '';

    // --- NAVIGATION ---
    function switchMainView(view, btn) {
      document.querySelectorAll('.sig-section').forEach(s => s.classList.remove('active'));
      document.getElementById('view-' + view).classList.add('active');
      document.querySelectorAll('.scenarioChips .chip').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
    }

    function switchMode(mode, btn) {
      currentMode = mode;
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('sign-title').textContent = mode === 'standard' ? 'Signer les Conditions BPC' : 'Signer les Conditions Seed';
      document.getElementById('pdfLink').href = PDFs[mode];
      updateHash();
    }

    // --- LOGIQUE TECHNIQUE (HASH PDF) ---
    async function updateHash() {
      const display = document.getElementById('pdfHashDisplay');
      display.textContent = "Calcul...";
      try {
        const r = await fetch(PDFs[currentMode] + '?v=' + Date.now());
        const buf = new Uint8Array(await r.arrayBuffer());
        currentHash = '0x' + keccak256(buf);
        display.textContent = currentHash;
      } catch(e) { display.textContent = "Erreur de chargement du PDF"; }
    }

    // --- SIGNATURE ---
    async function processSignature() {
      if(!window.ethereum) return alert("Wallet non d√©tect√©.");
      const btn = document.getElementById('signBtn');
      
      try {
        btn.disabled = true;
        btn.textContent = "üîê En attente du Wallet...";
        
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        const timestamp = new Date().toISOString();

        const message = `I, ${address}, agree to the BPC Terms (${PDFs[currentMode]})\nDoc ID: ${DOC_IDS[currentMode]}\nPDF Hash: ${currentHash}\nSigned on: ${timestamp}`;
        const signature = await signer.signMessage(message);

        const payload = { address, mode: currentMode, hash: currentHash, timestamp, signature, docId: DOC_IDS[currentMode] };
        const token = 'BPC1.' + btoa(JSON.stringify(payload));

        // Affichage
        document.getElementById('tokenResult').style.display = 'block';
        document.getElementById('tokenValue').textContent = token;
        
        // Webhook (Silencieux)
        fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(() => {});
        
      } catch(e) { alert("Signature annul√©e ou erreur."); }
      finally { btn.disabled = false; btn.textContent = "‚úçÔ∏è Signer avec le Wallet"; }
    }

    // --- V√âRIFICATION ---
    function processVerification() {
      const input = document.getElementById('verifyInput').value.trim();
      const resDiv = document.getElementById('verifyResult');
      const content = document.getElementById('verifyContent');

      if(!input.startsWith('BPC1.')) return alert("Format de token invalide.");

      try {
        const data = JSON.parse(atob(input.split('.')[1]));
        const message = `I, ${data.address}, agree to the BPC Terms (${PDFs[data.mode]})\nDoc ID: ${data.docId}\nPDF Hash: ${data.hash}\nSigned on: ${data.timestamp}`;
        const recovered = ethers.utils.verifyMessage(message, data.signature);

        if(recovered.toLowerCase() === data.address.toLowerCase()) {
          resDiv.style.display = 'block';
          resDiv.style.background = "#F0FDF4";
          content.innerHTML = `<strong>‚úÖ Signature Valide</strong><br>Signataire : ${data.address}<br>Document : ${data.docId}<br>Date : ${data.timestamp}`;
        } else {
          throw new Error();
        }
      } catch(e) {
        resDiv.style.display = 'block';
        resDiv.style.background = "#FEF2F2";
        content.innerHTML = `<strong>‚ùå Signature Invalide</strong><br>Le token a √©t√© modifi√© ou la signature ne correspond pas.`;
      }
    }

    function copyToken() {
      navigator.clipboard.writeText(document.getElementById('tokenValue').textContent);
      alert("Token copi√© !");
    }

    // Init au chargement
    updateHash();
  </script>
</body>
</html>
