<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlockPilot - Sign Terms</title>
  
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <style>
    :root {
      --bp-primary: #3C756E; --bp-primary-hover: #2E5C56;
      --bp-bg: #FFFFFF; --bp-surface: #F8FAFC; --bp-border: #E2E8F0;
      --bp-text: #0F172A; --bp-muted: #64748B;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bp-bg); color: var(--bp-text);
    }
    /* Mode Embed (dans l'iframe) */
    .embed body { padding: 0; background: transparent; }
    
    .container { max-width: 600px; margin: 0 auto; }
    .embed .container { max-width: 100%; }

    /* Header interne (cach√© en embed) */
    .header-int { display: flex; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--bp-border); }
    .embed .header-int { display: none; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; background: var(--bp-surface); padding: 4px; border-radius: 99px; width: fit-content; border: 1px solid var(--bp-border); }
    .tab {
      padding: 8px 16px; border-radius: 99px; font-weight: 600; font-size: 14px; cursor: pointer; color: var(--bp-muted); transition: all 0.2s;
    }
    .tab.active { background: #fff; color: var(--bp-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    h1 { font-size: 24px; font-weight: 700; margin: 0 0 8px; color: var(--bp-primary); }
    p.sub { font-size: 15px; color: var(--bp-muted); margin: 0 0 24px; line-height: 1.5; }

    /* Boutons */
    .btn-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin-bottom: 24px; }
    .btn {
      display: flex; align-items: center; justify-content: center; width: 100%;
      padding: 12px; border-radius: 99px; font-weight: 600; cursor: pointer; border: 1px solid var(--bp-border); font-size: 15px; text-decoration: none;
    }
    .btn-primary { background: var(--bp-primary); color: #fff; border-color: var(--bp-primary); }
    .btn-primary:hover { background: var(--bp-primary-hover); }
    .btn-ghost { background: #fff; color: var(--bp-muted); }
    .btn:disabled { opacity: 0.6; cursor: wait; }

    /* Tech Details */
    .tech { font-size: 13px; color: var(--bp-muted); margin-top: 32px; border-top: 1px solid var(--bp-border); padding-top: 16px; }
    .tech-toggle { cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; }
    .tech-content { display: none; margin-top: 12px; background: var(--bp-surface); padding: 12px; border-radius: 8px; word-break: break-all; font-family: monospace; }
    .tech-content.show { display: block; }

    /* Result Token */
    .token-box { display: none; margin-top: 24px; background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 12px; padding: 20px; }
    .token-code {
      background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #E2E8F0;
      font-family: monospace; font-size: 13px; word-break: break-all; margin: 12px 0; color: #064E3B;
    }
    .action-links { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .link-act { font-size: 13px; font-weight: 600; color: var(--bp-primary); cursor: pointer; text-decoration: underline; }
  </style>
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if(EMBED) document.documentElement.classList.add('embed');</script>
</head>
<body>

  <div class="header-int">
    <img src="assets/logo.png" alt="BPC" height="32">
    <div>
      <a href="?lang=fr" style="margin-right:12px;text-decoration:none;color:inherit;font-weight:600">FR</a>
      <a href="?lang=en" style="text-decoration:none;color:inherit;font-weight:600">EN</a>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <div id="tab-standard" class="tab active">Standard</div>
      <div id="tab-seed" class="tab">Seed</div>
    </div>

    <h1 id="title">Sign Terms & Conditions</h1>
    <p id="subtitle" class="sub">By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

    <div class="btn-row">
      <a id="viewPdfBtn" class="btn btn-ghost" href="./BPC_Terms.pdf" target="_blank">üìÑ PDF</a>
      <button id="signBtn" class="btn btn-primary" disabled>‚è≥ Preparing...</button>
    </div>

    <div id="tokenBox" class="token-box">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong style="color:#166534;" id="successTitle">‚úÖ Signed Successfully!</strong>
      </div>
      <div class="token-code" id="tokenCode">...</div>
      <div class="action-links">
        <span class="link-act" id="copyTokenBtn">Copy Token</span>
        <a class="link-act" id="dlJsonBtn" download="receipt.json" href="#">Download JSON</a>
      </div>
    </div>

    <div class="tech">
      <div class="tech-toggle" id="toggleTech">
        <span>‚ÑπÔ∏è Technical Details (Hash)</span>
      </div>
      <div class="tech-content" id="techDetails">
        <div><strong>PDF Hash (Keccak256):</strong></div>
        <div id="pdfHash" style="color:#3C756E; margin-bottom:8px;">...</div>
        <div><strong>Doc ID:</strong> <span id="docIdDisp">...</span></div>
      </div>
    </div>
  </div>

<script>
  // --- CONFIGURATION ---
  const PDFs = { standard: './BPC_Terms.pdf', seed: './BPC_Terms_Seed.pdf' };
  const TERMS_META = {
    standard: { docId: 'BPC_Terms v1.0 (2025-11-07)' },
    seed:     { docId: 'BPC_Terms_Seed v1.0 (2025-11-07)' }
  };
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxEr5Wky-9oz2H7QMaWvc0Xi7-u1hEm1Et-ZtKoPyek4Gp2tXH2FN3sx_ys1JqPtRPTLw/exec';

  // --- I18N ---
  const STR = {
    en: {
      titleStd: 'Sign Terms', titleSeed: 'Sign Seed Terms',
      subStd: 'Confirm you agree to the official BPC Terms.', subSeed: 'Confirm you agree to the BPC Seed Terms.',
      viewPdf: 'üìÑ View PDF', signBtn: '‚úçÔ∏è Sign with Wallet', preparing: '‚è≥ Preparing...', waiting:'üîê Check Wallet...',
      techLabel: '‚ÑπÔ∏è Technical Details (Hash)', success:'‚úÖ Signed Successfully!', copy:'Copy Token', dl:'Download JSON',
      alertWallet: 'Wallet not detected (MetaMask/Rabby)'
    },
    fr: {
      titleStd: 'Signer les Conditions', titleSeed: 'Signer Conditions Seed',
      subStd: 'Confirmez votre accord avec les Conditions BPC.', subSeed: 'Confirmez votre accord avec les Conditions Seed.',
      viewPdf: 'üìÑ Voir PDF', signBtn: '‚úçÔ∏è Signer avec Wallet', preparing: '‚è≥ Pr√©paration...', waiting:'üîê Validez dans Wallet...',
      techLabel: '‚ÑπÔ∏è D√©tails Techniques (Hash)', success:'‚úÖ Signature R√©ussie !', copy:'Copier Token', dl:'T√©l√©charger JSON',
      alertWallet: 'Wallet non d√©tect√© (MetaMask/Rabby)'
    }
  };
  
  const getLang = () => (new URLSearchParams(location.search).get('lang') || localStorage.getItem('bp_lang') || 'fr').startsWith('en') ? 'en' : 'fr';
  let lang = getLang();
  const t = (k) => STR[lang][k] || STR.en[k];

  // --- STATE ---
  let mode = 'standard';
  let pdfPath = PDFs[mode];
  let pdfHash = '';
  let signing = false;

  // --- LOGIC ---
  function updateUI() {
    document.getElementById('tab-standard').className = `tab ${mode==='standard'?'active':''}`;
    document.getElementById('tab-seed').className = `tab ${mode==='seed'?'active':''}`;
    
    document.getElementById('title').textContent = mode==='standard' ? t('titleStd') : t('titleSeed');
    document.getElementById('subtitle').textContent = mode==='standard' ? t('subStd') : t('subSeed');
    document.getElementById('viewPdfBtn').textContent = t('viewPdf');
    document.getElementById('viewPdfBtn').href = pdfPath;
    document.getElementById('docIdDisp').textContent = TERMS_META[mode].docId;
    
    document.querySelector('#toggleTech span').textContent = t('techLabel');
    document.getElementById('successTitle').textContent = t('success');
    document.getElementById('copyTokenBtn').textContent = t('copy');
    document.getElementById('dlJsonBtn').textContent = t('dl');

    const btn = document.getElementById('signBtn');
    if(!signing && pdfHash) {
      btn.textContent = t('signBtn');
      btn.disabled = false;
    }
  }

  async function loadMode(m) {
    mode = m; pdfPath = PDFs[mode];
    
    // Reset UI
    document.getElementById('tokenBox').style.display = 'none';
    const btn = document.getElementById('signBtn');
    btn.disabled = true; btn.textContent = t('preparing');
    document.getElementById('pdfHash').textContent = '...';
    
    updateUI();

    try {
      // Hash PDF
      const r = await fetch(pdfPath + '?v=' + Date.now());
      if(!r.ok) throw new Error('PDF Load Error');
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
      
      btn.disabled = false;
      updateUI();
    } catch(e) {
      console.error(e);
      btn.textContent = "‚ö†Ô∏è Error PDF";
    }
  }

  async function sign() {
    if(signing) return;
    const btn = document.getElementById('signBtn');

    try {
      if(!window.ethereum) return alert(t('alertWallet'));
      
      signing = true; btn.disabled = true; btn.textContent = t('waiting');
      
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      // Construct Message
      const timestamp = new Date().toISOString();
      const origin = location.origin;
      const docId = TERMS_META[mode].docId;
      
      const message = 
`I, ${address}, agree to the BPC Terms (${pdfPath})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      // Sign
      let signature;
      try { signature = await signer.signMessage(message); }
      catch {
        // Fallback personal_sign
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      // Payload & Token
      const payload = { mode, address, pdf: pdfPath, pdfHash, timestamp, signature, origin, docId };
      const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const jsonBlob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(jsonBlob);

      // Webhook
      fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(()=>{});

      // Display Result
      document.getElementById('tokenBox').style.display = 'block';
      document.getElementById('tokenCode').textContent = token;
      
      const copyBtn = document.getElementById('copyTokenBtn');
      copyBtn.onclick = () => { navigator.clipboard.writeText(token); alert('Copied!'); };
      
      const dlBtn = document.getElementById('dlJsonBtn');
      dlBtn.href = jsonUrl;
      dlBtn.download = `bpc_sig_${address.substring(0,6)}.json`;

      // Reset
      btn.textContent = t('signBtn');
      signing = false; btn.disabled = false;

    } catch(e) {
      console.error(e);
      alert("Sign Cancelled/Error");
      signing = false; btn.disabled = false; updateUI();
    }
  }

  // EVENTS
  document.getElementById('tab-standard').onclick = () => loadMode('standard');
  document.getElementById('tab-seed').onclick = () => loadMode('seed');
  document.getElementById('toggleTech').onclick = () => document.getElementById('techDetails').classList.toggle('show');
  document.getElementById('signBtn').onclick = sign;

  // BOOT
  document.addEventListener('DOMContentLoaded', () => loadMode('standard'));
</script>
</body>
</html>
