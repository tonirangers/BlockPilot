<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlockPilot Capital — Approval</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    .sig-section { display: none; }
    .sig-section.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .mode-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .mode-tab { padding: 8px 20px; border-radius: 99px; border: 1px solid var(--bp-border); background: #fff; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--bp-text-muted); transition: 0.2s; }
    .mode-tab.active { background: var(--bp-primary-soft); color: var(--bp-primary); border-color: var(--bp-primary); }

    .output-box { background: var(--bp-surface-alt); padding: 24px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--bp-border); }
    .token-box { background: #fff; border: 1px solid var(--bp-border); padding: 20px; border-radius: 12px; margin-top: 16px; }
    .token-box code { background: var(--bp-surface-alt); padding: 12px; border-radius: 8px; display: block; margin: 12px 0; font-size: 11px; word-break: break-all; border: 1px solid var(--bp-border); font-family: monospace; }
    
    .tech-trigger { cursor: pointer; font-size: 13px; font-weight: 600; color: var(--bp-text-muted); display: flex; align-items: center; gap: 8px; margin-top: 24px; }
    .tech-content { display: none; margin-top: 12px; padding: 16px; background: var(--bp-surface-alt); border-radius: 8px; font-size: 12px; border: 1px solid var(--bp-border); }
    .tech-content.show { display: block; }

    .verify-area { width: 100%; height: 160px; font-family: monospace; font-size: 13px; margin: 16px 0; border-radius: 12px; }
    
    .status-valid { color: #166534; background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0; font-weight: 600; }
  </style>
</head>
<body data-lang="en">
<header class="header">
  <div class="container">
    <nav class="nav">
      <a class="brand" href="./index.html" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
        <img class="brand__logo" src="../logo.png" alt="BlockPilot" style="width: 40px; height: 40px; border-radius: 8px;">
        <span style="font-weight: 800; font-size: 20px; color: var(--bp-text-main); letter-spacing: -0.02em;">BlockPilot</span>
      </a>

      <button class="navToggle" id="navToggle" type="button">Menu</button>

      <div class="nav__links">
        <a href="./index.html#performance">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
          Performance
        </a>
        
        <a href="./index.html#security">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          Sécurité
        </a>

        <a href="./signature.html" class="active">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon></svg>
          Signature
        </a>
      </div>

      <div class="lang">
        <a class="pill is-active" href="../fr/index.html">FR</a>
        <a class="pill" href="../en/index.html">EN</a>
      </div>
    </nav>
  </div>
</header>

  <main class="section">
    <div class="container">
      <h1 class="h1">Terms Approval</h1>
      <p class="p">Sign our general terms and conditions immutably. Through cryptography, your agreement is etched in stone for total transparency.</p>

      <div class="scenarioChips" style="margin-bottom: 32px;">
        <button class="chip active" id="tabSign" onclick="switchMainView('sign', this)">Sign Document</button>
        <button class="chip" id="tabVerify" onclick="switchMainView('verify', this)">Verify Signature</button>
      </div>

      <div class="bp-card">
        
        <div id="view-sign" class="sig-section active">
          <div class="mode-tabs">
            <div class="mode-tab active" id="btn-std" onclick="switchMode('standard')">SAFE Configuration</div>
            <div class="mode-tab" id="btn-seed" onclick="switchMode('seed')">EOA Wallet</div>
          </div>

          <h2 class="cardTitle" id="display-title">BlockPilot Capital General Terms</h2>
          <p class="cardSub" id="display-sub">By signing, you confirm that you have read and accepted the official terms.</p>
          <div style="margin-top:12px; font-size: 13px; color: var(--bp-text-muted);">
            Note: Off-chain cryptographic signature (0 gas).
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 16px; margin: 32px 0;">
            <a id="pdfLink" href="../BPC_Terms.pdf" target="_blank" class="btn">View document (PDF)</a>
            <button id="signBtn" class="btn btn--primary" onclick="processSignature()">Sign with wallet</button>
          </div>

          <div class="tech-trigger" onclick="document.getElementById('tech-content').classList.toggle('show')">
            <span>Technical Integrity Properties</span>
            <span style="font-size:10px;">▼</span>
          </div>
          <div class="tech-content" id="tech-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <strong>Digital Fingerprint (Keccak-256)</strong>
                <span id="pdfNameDisp" style="color:var(--bp-text-muted);">BPC_Terms.pdf</span>
            </div>
            <div id="pdfHash" style="font-family:monospace; color:var(--bp-primary); font-size:11px;">Computing fingerprint...</div>
          </div>

          <div id="signatureOutput" style="display:none;">
            <div class="output-box" id="fullReceipt"></div>
            <div class="token-box">
                <strong style="font-size:14px; color:var(--bp-primary);">Verification Certificate</strong>
                <code id="tokenValue"></code>
                <button class="btn" style="padding:6px 16px; font-size:12px;" onclick="copyText('tokenValue')">Copy certificate</button>
                <p style="font-size:11px; color:var(--bp-text-muted); margin-top:12px;">This certificate allows the authentication of your signature via the verification tab.</p>
            </div>
          </div>
        </div>

        <div id="view-verify" class="sig-section">
          <h2 class="cardTitle">Integrity Verification</h2>
          <p class="cardSub">Authenticate a BlockPilot Capital certificate to validate the signer and the document.</p>
          
          <textarea id="verifyInput" class="input verify-area" placeholder="Paste BPC1 certificate here..."></textarea>
          <button class="btn btn--primary" onclick="processVerification()">Verify validity</button>

          <div id="verifyResult" style="margin-top:24px;"></div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">© Copyright BlockPilot Capital ltd 2025 · <a href="https://t.me/tonirangers">Telegram</a></div>
  </footer>

  <script>
    const PDFs = { standard: '../BPC_Terms.pdf', seed: '../BPC_Terms_Seed.pdf' };
    const DOC_IDS = { standard: 'BlockPilot Capital Terms v1.0', seed: 'BlockPilot Capital Seed Terms v1.0' };
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxEr5Wky-9oz2H7QMaWvc0Xi7-u1hEm1Et-ZtKoPyek4Gp2tXH2FN3sx_ys1JqPtRPTLw/exec';

    let currentMode = 'standard';
    let currentHash = '';

    function switchMainView(view, btn) {
      document.querySelectorAll('.sig-section').forEach(s => s.classList.remove('active'));
      document.getElementById('view-' + view).classList.add('active');
      document.querySelectorAll('.scenarioChips .chip').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
    }

    function switchMode(mode) {
      currentMode = mode;
      document.getElementById('btn-std').classList.toggle('active', mode === 'standard');
      document.getElementById('btn-seed').classList.toggle('active', mode === 'seed');
      document.getElementById('display-title').textContent = mode === 'standard' ? 'BlockPilot Capital General Terms' : 'BlockPilot Capital Seed Terms';
      document.getElementById('pdfLink').href = PDFs[mode];
      document.getElementById('pdfNameDisp').textContent = mode === 'standard' ? 'BPC_Terms.pdf' : 'BPC_Terms_Seed.pdf';
      document.getElementById('signatureOutput').style.display = 'none';
      updateHash();
    }

    async function updateHash() {
      const hashEl = document.getElementById('pdfHash');
      hashEl.textContent = "Computing...";
      try {
        const r = await fetch(PDFs[currentMode] + '?v=' + Date.now());
        const buf = new Uint8Array(await r.arrayBuffer());
        currentHash = '0x' + keccak256(buf);
        hashEl.textContent = currentHash;
      } catch(e) { hashEl.textContent = "PDF Error"; }
    }

    async function processSignature() {
      if(!window.ethereum) return alert("Wallet not detected.");
      const btn = document.getElementById('signBtn');
      try {
        btn.disabled = true; btn.textContent = "Processing validation...";
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        const timestamp = new Date().toISOString();

        const message = `I, ${address}, agree to the BlockPilot Capital Terms (${PDFs[currentMode]})\nDoc ID: ${DOC_IDS[currentMode]}\nPDF Hash: ${currentHash}\nSigned on: ${timestamp}`;
        const signature = await signer.signMessage(message);

        const payload = { address, mode: currentMode, pdfHash: currentHash, timestamp, signature, docId: DOC_IDS[currentMode] };
        const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));

        document.getElementById('signatureOutput').style.display = 'block';
        document.getElementById('tokenValue').textContent = token;
        document.getElementById('fullReceipt').innerHTML = `
            <div class="status-valid">
                Document successfully approved by: ${address.substring(0,6)}...${address.substring(38)}
            </div>
            <div style="font-size:12px; line-height:1.6; color:var(--bp-text-muted); margin-top:16px;">
                Timestamp: ${timestamp}<br>
                Document ID: ${DOC_IDS[currentMode]}<br>
                Immutable Fingerprint: ${currentHash.substring(0,20)}...
            </div>
        `;
        
        fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(() => {});
      } catch(e) { alert("Signature denied."); }
      finally { btn.disabled = false; btn.textContent = "Sign with wallet"; }
    }

    function processVerification() {
      const input = document.getElementById('verifyInput').value.trim();
      const resDiv = document.getElementById('verifyResult');
      try {
        const raw = atob(input.split('.')[1]);
        const data = JSON.parse(decodeURIComponent(escape(raw)));
        resDiv.innerHTML = `
          <div class="status-valid">
            Authentic certificate detected<br>
            <span style="font-size:13px; font-weight:400;">Signer: ${data.address}</span><br>
            <span style="font-size:13px; font-weight:400;">Document: ${data.docId}</span>
          </div>`;
      } catch(e) {
        resDiv.innerHTML = `<div style="padding:16px; background:#fef2f2; color:#991b1b; border-radius:8px; border:1px solid #fecaca;">Invalid or corrupted certificate</div>`;
      }
    }

    function copyText(id) {
      navigator.clipboard.writeText(document.getElementById(id).textContent);
      alert("Copied!");
    }

    updateHash();
  </script>
</body>
</html>
