<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlockPilot Capital — Approbation</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    .sig-section { display: none; }
    .sig-section.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .mode-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .mode-tab { padding: 8px 20px; border-radius: 99px; border: 1px solid var(--bp-border); background: #fff; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--bp-text-muted); transition: 0.2s; }
    .mode-tab.active { background: var(--bp-primary-soft); color: var(--bp-primary); border-color: var(--bp-primary); }

    .output-box { background: var(--bp-surface-alt); padding: 24px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--bp-border); }
    .token-box { background: #fff; border: 1px solid var(--bp-border); padding: 20px; border-radius: 12px; margin-top: 16px; }
    .token-box code { background: var(--bp-surface-alt); padding: 12px; border-radius: 8px; display: block; margin: 12px 0; font-size: 11px; word-break: break-all; border: 1px solid var(--bp-border); font-family: monospace; }
    
    /* Accordéon Tech */
    .tech-trigger { cursor: pointer; font-size: 13px; font-weight: 600; color: var(--bp-text-muted); display: flex; align-items: center; gap: 8px; margin-top: 24px; }
    .tech-content { display: none; margin-top: 12px; padding: 16px; background: var(--bp-surface-alt); border-radius: 8px; font-size: 12px; border: 1px solid var(--bp-border); }
    .tech-content.show { display: block; }

    .verify-area { width: 100%; height: 160px; font-family: monospace; font-size: 13px; margin: 16px 0; border-radius: 12px; }
    
    /* Status UI améliorée */
    .status-valid { color: #166534; background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0; font-weight: 600; }
  </style>
</head>
<body data-lang="fr">
  <header class="header">
    <div class="container">
      <nav class="nav">
<a class="brand" href="./index.html" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
  <img class="brand__logo" src="../logo.png" alt="BlockPilot" style="width: 42px; height: 42px;">
  <span style="font-weight: 800; font-size: 18px; color: var(--bp-text-main); letter-spacing: -0.02em;">BlockPilot</span>
</a>
        <button class="navToggle" id="navToggle">Menu</button>
        <div class="nav__links">
          <a href="./index.html#performance">Performance</a>
          <a href="./index.html#security">Sécurité</a>
          <a id="navDocs" href="#docs" style="opacity:0.5;">Docs</a>
          <a href="./signature.html" class="active">Signature</a>
        </div>
        <div class="lang">
          <a class="pill is-active" href="./signature.html">FR</a>
          <a class="pill" href="../en/signature.html">EN</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 class="h1">Approbation des Conditions</h1>
      <p class="p">Signez nos conditions générales de manière immuable. Grâce à la cryptographie, votre accord est gravé dans le marbre pour une transparence totale.</p>

      <div class="scenarioChips" style="margin-bottom: 32px;">
        <button class="chip active" id="tabSign" onclick="switchMainView('sign', this)">Signer le document</button>
        <button class="chip" id="tabVerify" onclick="switchMainView('verify', this)">Vérifier une signature</button>
      </div>

      <div class="bp-card">
        
        <div id="view-sign" class="sig-section active">
          <div class="mode-tabs">
            <div class="mode-tab active" id="btn-std" onclick="switchMode('standard')">Configuration SAFE</div>
            <div class="mode-tab" id="btn-seed" onclick="switchMode('seed')">Portefeuille EOA</div>
          </div>

          <h2 class="cardTitle" id="display-title">Conditions Générales BlockPilot Capital</h2>
          <p class="cardSub" id="display-sub">En signant, vous confirmez avoir pris connaissance et accepté les conditions officielles.</p>
          <div style="margin-top:12px; font-size: 13px; color: var(--bp-text-muted);">
            Note : Signature cryptographique hors-chaîne (0 gas).
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 16px; margin: 32px 0;">
            <a id="pdfLink" href="../BPC_Terms.pdf" target="_blank" class="btn">Consulter le document (PDF)</a>
            <button id="signBtn" class="btn btn--primary" onclick="processSignature()">Signer avec le wallet</button>
          </div>

          <div class="tech-trigger" onclick="document.getElementById('tech-content').classList.toggle('show')">
            <span>Propriétés d'intégrité technique</span>
            <span style="font-size:10px;">▼</span>
          </div>
          <div class="tech-content" id="tech-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <strong>Empreinte numérique (Keccak-256)</strong>
                <span id="pdfNameDisp" style="color:var(--bp-text-muted);">BPC_Terms.pdf</span>
            </div>
            <div id="pdfHash" style="font-family:monospace; color:var(--bp-primary); font-size:11px;">Calcul de l'empreinte...</div>
          </div>

          <div id="signatureOutput" style="display:none;">
            <div class="output-box" id="fullReceipt"></div>
            <div class="token-box">
                <strong style="font-size:14px; color:var(--bp-primary);">Certificat de vérification</strong>
                <code id="tokenValue"></code>
                <button class="btn" style="padding:6px 16px; font-size:12px;" onclick="copyText('tokenValue')">Copier le certificat</button>
                <p style="font-size:11px; color:var(--bp-text-muted); margin-top:12px;">Ce certificat permet d'authentifier votre signature via l'onglet de vérification.</p>
            </div>
          </div>
        </div>

        <div id="view-verify" class="sig-section">
          <h2 class="cardTitle">Vérification d'intégrité</h2>
          <p class="cardSub">Authentifiez un certificat BlockPilot Capital pour valider le signataire et le document.</p>
          
          <textarea id="verifyInput" class="input verify-area" placeholder="Collez le certificat BPC1..."></textarea>
          <button class="btn btn--primary" onclick="processVerification()">Vérifier la validité</button>

          <div id="verifyResult" style="margin-top:24px;"></div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">© Copyright BlockPilot Capital ltd 2025 · <a href="https://t.me/tonirangers">Telegram</a></div>
  </footer>

  <script>
    const PDFs = { standard: '../BPC_Terms.pdf', seed: '../BPC_Terms_Seed.pdf' };
    const DOC_IDS = { standard: 'BlockPilot Capital Terms v1.0', seed: 'BlockPilot Capital Seed Terms v1.0' };
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxEr5Wky-9oz2H7QMaWvc0Xi7-u1hEm1Et-ZtKoPyek4Gp2tXH2FN3sx_ys1JqPtRPTLw/exec';

    let currentMode = 'standard';
    let currentHash = '';

    function switchMainView(view, btn) {
      document.querySelectorAll('.sig-section').forEach(s => s.classList.remove('active'));
      document.getElementById('view-' + view).classList.add('active');
      document.querySelectorAll('.scenarioChips .chip').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
    }

    function switchMode(mode) {
      currentMode = mode;
      document.getElementById('btn-std').classList.toggle('active', mode === 'standard');
      document.getElementById('btn-seed').classList.toggle('active', mode === 'seed');
      document.getElementById('display-title').textContent = mode === 'standard' ? 'Conditions Générales BlockPilot Capital' : 'Conditions Seed BlockPilot Capital';
      document.getElementById('pdfLink').href = PDFs[mode];
      document.getElementById('pdfNameDisp').textContent = mode === 'standard' ? 'BPC_Terms.pdf' : 'BPC_Terms_Seed.pdf';
      document.getElementById('signatureOutput').style.display = 'none';
      updateHash();
    }

    async function updateHash() {
      const hashEl = document.getElementById('pdfHash');
      hashEl.textContent = "Calcul...";
      try {
        const r = await fetch(PDFs[currentMode] + '?v=' + Date.now());
        const buf = new Uint8Array(await r.arrayBuffer());
        currentHash = '0x' + keccak256(buf);
        hashEl.textContent = currentHash;
      } catch(e) { hashEl.textContent = "Erreur PDF"; }
    }

    async function processSignature() {
      if(!window.ethereum) return alert("Wallet non détecté.");
      const btn = document.getElementById('signBtn');
      try {
        btn.disabled = true; btn.textContent = "Validation en cours...";
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        const timestamp = new Date().toISOString();

        const message = `I, ${address}, agree to the BlockPilot Capital Terms (${PDFs[currentMode]})\nDoc ID: ${DOC_IDS[currentMode]}\nPDF Hash: ${currentHash}\nSigned on: ${timestamp}`;
        const signature = await signer.signMessage(message);

        const payload = { address, mode: currentMode, pdfHash: currentHash, timestamp, signature, docId: DOC_IDS[currentMode] };
        const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));

        document.getElementById('signatureOutput').style.display = 'block';
        document.getElementById('tokenValue').textContent = token;
        document.getElementById('fullReceipt').innerHTML = `
            <div class="status-valid">
                Document approuvé avec succès par : ${address.substring(0,6)}...${address.substring(38)}
            </div>
            <div style="font-size:12px; line-height:1.6; color:var(--bp-text-muted); margin-top:16px;">
                Horodatage : ${timestamp}<br>
                ID Document : ${DOC_IDS[currentMode]}<br>
                Empreinte immuable : ${currentHash.substring(0,20)}...
            </div>
        `;
        
        fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(() => {});
      } catch(e) { alert("Signature refusée."); }
      finally { btn.disabled = false; btn.textContent = "Signer avec le wallet"; }
    }

    function processVerification() {
      const input = document.getElementById('verifyInput').value.trim();
      const resDiv = document.getElementById('verifyResult');
      try {
        const raw = atob(input.split('.')[1]);
        const data = JSON.parse(decodeURIComponent(escape(raw)));
        resDiv.innerHTML = `
          <div class="status-valid">
            Certificat authentique détecté<br>
            <span style="font-size:13px; font-weight:400;">Signataire : ${data.address}</span><br>
            <span style="font-size:13px; font-weight:400;">Document : ${data.docId}</span>
          </div>`;
      } catch(e) {
        resDiv.innerHTML = `<div style="padding:16px; background:#fef2f2; color:#991b1b; border-radius:8px; border:1px solid #fecaca;">Certificat invalide ou corrompu</div>`;
      }
    }

    function copyText(id) {
      navigator.clipboard.writeText(document.getElementById(id).textContent);
      alert("Copié !");
    }

    updateHash();
  </script>
</body>
</html>
