<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BPC ‚Äî Sign (Standard & Seed)</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <script>const EMBED = new URLSearchParams(location.search).get('embed')==='1'; if (EMBED) document.documentElement.classList.add('embed');</script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <style>
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);margin:0;min-height:100vh;display:flex;flex-direction:column;}
    .embed body{background:transparent;}
    .sign-shell{flex:1;display:flex;flex-direction:column;gap:20px;align-items:center;padding:30px 18px 50px;}
    .embed .sign-shell{padding:0;}
    .embed .header{display:none;}
    .sign-card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:24px;max-width:760px;width:100%;}
    .embed .sign-card{border:0;box-shadow:none;background:transparent;padding:10px 0 0;}
    .sign-card h1{font-size:26px;margin:0 0 10px;}
    .sign-card p{font-size:16px;margin-bottom:12px;}
    .sign-tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px;}
    .sign-tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:rgba(11,111,102,.08);color:var(--brand);font-weight:800;cursor:pointer;}
    .sign-tab.active{background:var(--brand);color:#fff;border-color:rgba(11,111,102,.55);}
    .sign-row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;}
    .sign-btn{display:flex;align-items:center;justify-content:center;flex:1 1 220px;padding:14px;border-radius:14px;font-weight:900;text-decoration:none;border:1px solid rgba(13,35,31,.14);background:rgba(255,255,255,.9);cursor:pointer;}
    .sign-btn.primary{background:var(--brand);color:#fff;border-color:rgba(11,111,102,.55);}
    .sign-btn.ghost{background:rgba(11,111,102,.08);color:var(--brand);}
    .hash-line{font-size:14px;color:var(--muted);margin:18px 0;word-break:break-word}
    .output-box{background:rgba(238,247,245,.35);padding:16px;border-radius:12px;margin-top:14px;text-align:left;overflow-wrap:anywhere;border:1px solid var(--line)}
    .copy-btn{background:var(--brand);color:#fff;padding:10px 14px;border:0;border-radius:10px;font-size:14px;margin:6px 6px 0 0;cursor:pointer;display:inline-block}
    .copy-btn:hover{background:var(--brand2)}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    .muted{color:var(--muted)}
    .actions{margin-top:8px}
  </style>

</head>
<body>
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="./fr/" aria-label="BlockPilot">
          <img class="brand__logo" src="logo.png" alt="BlockPilot" />
        </a>
        <div class="nav__links" aria-label="Navigation">
          <a href="./fr/">FR</a>
          <a href="./en/">EN</a>
          <a href="./verify.html">Verify</a>
        </div>
      </nav>
    </div>
  </header>

  <div class="sign-shell">
    <div class="sign-card">
      <div style="text-align:center;">
        <img src="logo.png" alt="BPC" style="height:72px;width:72px;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 24px rgba(13,35,31,.08);margin:0 auto 12px;" onerror="this.style.display='none'">
      </div>

      <div class="sign-tabs" role="tablist">
        <span class="sign-tab" id="tab-standard">Standard</span>
        <span class="sign-tab" id="tab-seed">Seed</span>
      </div>

      <h1 id="title">Sign Terms &amp; Conditions</h1>
      <p id="subtitle" class="muted">By signing, you confirm you‚Äôve read and agree to the official BPC Terms.</p>

      <div class="sign-row">
        <a id="viewPdfBtn" class="sign-btn ghost" href="./BPC_Terms.pdf" target="_blank" rel="noopener">üìÑ View PDF Terms</a>
        <button id="signBtn" class="sign-btn primary" disabled>‚è≥ Preparing‚Ä¶</button>
      </div>

      <div class="hash-line">PDF (<span id="pdfName">BPC_Terms.pdf</span>) ‚Ä¢ Keccak-256: <span id="pdfHash">‚Ä¶</span></div>

      <div id="signatureOutput"></div>

      <p class="small">‚úÖ You can verify signatures anytime on <a href="verify.html">verify.html</a>.</p>
    </div>
  </div>
<script>
  // ---- Config
  const PDFs = { standard: './BPC_Terms.pdf', seed: './BPC_Terms_Seed.pdf' };
  const TERMS_META = {
    standard: { docId: 'BPC_Terms v1.0 (2025-11-07)' },
    seed:     { docId: 'BPC_Terms_Seed v1.0 (2025-11-07)' }
  };
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzOmjt11dQ3vmYtVrydXl6gejh0lVwqiSxCbXMhUVpQPNBFoMTUP2JJlAj0atjTOcfDtg/exec';

  // ---- State
  let mode = 'standard';
  let pdfPath = PDFs[mode];
  let pdfHash = '';
  let signing = false;

  // ---- Init
  document.addEventListener('DOMContentLoaded', () => {
    const params = getHashParams();
    if (params.mode === 'seed') mode = 'seed';
    applyMode();
  });

  document.getElementById('tab-standard').addEventListener('click', () => { mode='standard'; applyMode(true); });
  document.getElementById('tab-seed').addEventListener('click', () => { mode='seed'; applyMode(true); });
  document.getElementById('signBtn').addEventListener('click', signTerms);

  function getHashParams() {
    const h = (location.hash||'').replace(/^#/,'');
    const o = {};
    h.split('&').forEach(kv => {
      const [k,v] = kv.split('=');
      if (k) o[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
    });
    return o;
  }

  async function applyMode(pushHash=false) {
    pdfPath = PDFs[mode];
    // tabs
    document.getElementById('tab-standard').classList.toggle('active', mode==='standard');
    document.getElementById('tab-seed').classList.toggle('active', mode==='seed');
    // titles
    document.getElementById('title').textContent = mode==='standard' ? 'Sign Terms & Conditions' : 'Sign Terms & Conditions (Seed)';
    document.getElementById('subtitle').textContent = mode==='standard'
      ? 'By signing, you confirm you‚Äôve read and agree to the official BPC Terms.'
      : 'By signing, you confirm you‚Äôve read and agree to the official BPC Seed Terms.';
    // links
    document.getElementById('viewPdfBtn').href = pdfPath;
    document.getElementById('pdfName').textContent = pdfPath;

    // clear previous receipt
    document.getElementById('signatureOutput').innerHTML = '';

    // disable button while hashing
    const btn = document.getElementById('signBtn');
    signing = false;
    btn.disabled = true; btn.textContent = '‚è≥ Preparing‚Ä¶';

    // compute hash
    pdfHash = '';
    document.getElementById('pdfHash').textContent = '‚Ä¶';
    try {
      const r = await fetch(pdfPath + '?v=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Fetch PDF failed: ' + r.status);
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
      btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign with Wallet';
    } catch(e){
      console.error('PDF hash error:', e);
      btn.disabled = true; btn.textContent = '‚ö†Ô∏è PDF hash error';
    }

    if (pushHash) location.hash = `mode=${mode}`;
  }

  async function signTerms() {
    if (signing) return;
    const btn = document.getElementById('signBtn');
    try {
      if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask/Zeal)'); return; }
      signing = true; btn.disabled = true; btn.textContent = 'üîê Waiting wallet‚Ä¶';

      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      for (let i=0;i<50 && !pdfHash;i++) await new Promise(r=>setTimeout(r,100));
      if (!pdfHash) { alert('PDF hash not ready yet. Please retry in 1s.'); signing = false; btn.disabled=false; btn.textContent='‚úçÔ∏è Sign with Wallet'; return; }

      const timestamp = new Date().toISOString();
      const origin = location.origin;
      const docId = TERMS_META[mode].docId;

      const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
Doc ID: ${docId}
Origin: ${origin}
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      let signature;
      try { signature = await signer.signMessage(message); }
      catch {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      const block =
`Signed as: ${address}
Doc ID: ${docId}
Origin: ${origin}
PDF: ${pdfPath}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      const payload = { mode, address, pdf: pdfPath, pdfHash, timestamp, signature, origin, docId, userAgent: navigator.userAgent };
      const token   = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const verifyUrl = new URL('verify.html', location.href).toString();
      const verifyLink = `${verifyUrl}#mode=${mode}&token=${encodeURIComponent(token)}`;

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      // Log to Google Sheets (best-effort)
      if (WEBHOOK_URL) {
        try {
          await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
        } catch (e) { /* silencieux */ }
      }

      // Render receipt
      document.getElementById('signatureOutput').innerHTML = `
        <div class="output-box">
          ‚úÖ <b>Signed as:</b> ${address} <span class="muted">[${mode}]</span><br>
          üïí <b>Timestamp:</b> ${timestamp}<br>
          üìÑ <b>Doc ID:</b> ${docId}<br>
          üåê <b>Origin:</b> ${origin}<br>
          üìò <b>PDF:</b> ${pdfPath}<br>
          üßÆ <b>PDF Hash:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>Signature:</b><br>${signature}<br><br>

          <div class="actions">
            <button class="copy-btn" onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)' title="Copier le bloc lisible">üìã Copy block</button>
            <button class="copy-btn" onclick='copyText(\`${token}\`)' title="Coller dans verify.html">üîë Copy token</button>
            <a class="copy-btn" href="${jsonUrl}" download="bpc-signature-${address}.json" title="Re√ßu JSON">‚¨áÔ∏è Download JSON</a>
            <a class="copy-btn" href="${verifyLink}" target="_blank" rel="noopener" title="Lien direct de v√©rification">üîó Open verify</a>
          </div>

          <div class="actions">
            <button class="copy-btn" onclick='shareLink("${verifyLink}")'>üì§ Share link</button>
            <button class="copy-btn" onclick='shareToken("${token}")'>üîë Share token</button>
            <button class="copy-btn" onclick='shareJsonFile("bpc-signature-${address}.json", \`${json.replace(/`/g,"\\`")}\`)'>üßæ Share JSON</button>
          </div>
        </div>
      `;

      // reset button
      signing = false; btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign again';
    } catch (err) {
      console.error(err);
      signing = false;
      btn.disabled = false; btn.textContent = '‚úçÔ∏è Sign with Wallet';
      alert('Signing cancelled or failed.');
    }
  }

  function copyText(s){ navigator.clipboard.writeText(s||''); alert('Copied!'); }

  // --- Share helpers (Web Share API + fallbacks)
  async function shareLink(url){
    try{
      if(navigator.share){ await navigator.share({title:'BPC ‚Äî Verify',text:'V√©rifier ma signature BPC :',url}); }
      else { await navigator.clipboard.writeText(url); alert('Link copied!'); }
    }catch(_){}
  }
  async function shareToken(token){
    const text = `BPC verify token:\n${token}`;
    try{
      if(navigator.share){ await navigator.share({title:'BPC ‚Äî Token',text}); }
      else { await navigator.clipboard.writeText(text); alert('Token copied!'); }
    }catch(_){}
  }
  async function shareJsonFile(filename, jsonStr){
    try{
      const file = new File([jsonStr], filename, {type:'application/json'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({ title:'BPC ‚Äî JSON Receipt', files:[file] });
      }else{
        // fallback: t√©l√©chargement direct
        const blob = new Blob([jsonStr], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), {href:url, download:filename});
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
    }catch(_){}
  }
</script>
</body>
</html>
