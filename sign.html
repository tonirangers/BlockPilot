<script>
  // 1) Calcul auto du hash du PDF (pas de variable "hash" ailleurs)
  const pdfPath = 'BPC_Terms.pdf'; // üëâ pour la version seed, mets 'BPC_Terms_Seed.pdf'
  let pdfHash = '';

  (async () => {
    try {
      const r = await fetch(pdfPath, { cache: 'no-store' });
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf); // fourni par js-sha3
      const el = document.getElementById('pdfHash');
      if (el) el.textContent = pdfHash;
    } catch (e) {
      console.error('PDF hash error:', e);
    }
  })();

  // 2) Signature
  async function signTerms() {
    try {
      if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask)'); return; }

      // Rabby aime bien ce call en premier
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      // Attends le hash si pas encore charg√© (max ~5s)
      for (let i = 0; i < 50 && !pdfHash; i++) await new Promise(r => setTimeout(r, 100));
      if (!pdfHash) { alert('PDF hash not ready yet. Please retry in 1s.'); return; }

      const timestamp = new Date().toISOString();
      const message =
`I, ${address}, agree to the BPC Terms (BPC_Terms.pdf)
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      // Essaye signMessage, fallback vers personal_sign (tr√®s compatible Rabby)
      let signature;
      try {
        signature = await signer.signMessage(message);
      } catch (e) {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      const block =
`Signed as: ${address}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      document.getElementById('signatureOutput').innerHTML = `
        <div class='output-box'>
          ‚úÖ <b>Signed as:</b> ${address}<br>
          üïí <b>Timestamp:</b> ${timestamp}<br>
          üìÑ <b>PDF Hash:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>Signature:</b><br>${signature}<br>
          <button class='copy-btn' onclick='copyFull()'>üìã Copy to Clipboard</button>
        </div>
      `;
      window.fullSig = block;
    } catch (err) {
      console.error(err);
      alert('Signing cancelled or failed.');
    }
  }

  function copyFull() {
    navigator.clipboard.writeText(window.fullSig || '');
    alert('Copied!');
  }
</script>
