<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Terms & Conditions (Seed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f9f9f9;display:flex;justify-content:center;align-items:center;padding:40px 20px;margin:0}
    .container{background:#fff;padding:30px;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,.05);max-width:600px;width:100%;text-align:center}
    .logo{height:150px;display:block;margin:0 auto 12px}
    h1{font-size:26px;margin:0 0 10px}
    p{font-size:16px;margin-bottom:24px}
    :root{--blue:#0a6cff;--blueH:#055ad6;--ghost:#eaf2ff}
    .btn{display:flex;align-items:center;justify-content:center;width:100%;margin:10px 0;padding:14px;border-radius:12px;font-size:16px;font-weight:700;text-decoration:none;border:0;cursor:pointer}
    .btn-ghost{background:var(--ghost);color:var(--blue)}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blueH)}
    .hash-line{font-size:14px;color:#555;margin:18px 0;word-break:break-word}
    .output-box{background:#eee;padding:16px;border-radius:10px;margin-top:20px;text-align:left;overflow-wrap:anywhere}
    .copy-btn{background:#28a745;color:#fff;padding:10px 14px;border:0;border-radius:8px;font-size:14px;margin:6px 6px 0 0;cursor:pointer;display:inline-block}
    .copy-btn:hover{background:#1e7e34}
    .small{font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="BPC" class="logo" onerror="this.style.display='none'">
    <h1>Sign Terms &amp; Conditions (Seed)</h1>
    <p>By signing, you confirm you‚Äôve read and agree to the official BPC Seed Terms.</p>

    <a class="btn btn-ghost" href="BPC_Terms_Seed.pdf" target="_blank">üìÑ View PDF Terms</a>
    <button class="btn btn-primary" onclick="signTerms()">‚úçÔ∏è Sign with Wallet</button>

    <div class="hash-line">PDF Hash (Keccak-256): <span id="pdfHash">‚Ä¶</span></div>
    <div id="signatureOutput"></div>

    <p class="small">‚úÖ You can verify your signature anytime on <a href="verify_seed.html">verify_seed.html</a>.</p>
  </div>

<script>
  const pdfPath = 'BPC_Terms_Seed.pdf';
  let pdfHash = '';

  (async () => {
    try {
      const r = await fetch(pdfPath, { cache: 'no-store' });
      const buf = new Uint8Array(await r.arrayBuffer());
      pdfHash = '0x' + keccak256(buf);
      document.getElementById('pdfHash').textContent = pdfHash;
    } catch (e) {
      console.error('PDF hash error:', e);
    }
  })();

  async function signTerms() {
    try {
      if (!window.ethereum) { alert('Wallet not detected (Rabby/MetaMask)'); return; }
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();

      for (let i=0;i<50 && !pdfHash;i++) await new Promise(r=>setTimeout(r,100));
      if (!pdfHash) { alert('PDF hash not ready yet. Please retry in 1s.'); return; }

      const timestamp = new Date().toISOString();
      const message =
`I, ${address}, agree to the BPC Terms (${pdfPath})
PDF Hash: ${pdfHash}
Signed on: ${timestamp}`;

      let signature;
      try { signature = await signer.signMessage(message); }
      catch (e) {
        const hex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message));
        signature = await window.ethereum.request({ method: 'personal_sign', params: [hex, address] });
      }

      const block =
`Signed as: ${address}
PDF Hash: ${pdfHash}
Timestamp: ${timestamp}
Signature:
${signature}`;

      const payload = { address, pdf: pdfPath, pdfHash, timestamp, signature };
      const token = 'BPC1.' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const verifyLink = `verify_seed.html#token=${encodeURIComponent(token)}`;

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:'application/json' });
      const jsonUrl = URL.createObjectURL(blob);

      document.getElementById('signatureOutput').innerHTML = `
        <div class="output-box">
          ‚úÖ <b>Signed as:</b> ${address}<br>
          üïí <b>Timestamp:</b> ${timestamp}<br>
          üìÑ <b>PDF:</b> ${pdfPath}<br>
          üßÆ <b>PDF Hash:</b> ${pdfHash}<br>
          ‚úçÔ∏è <b>Signature:</b><br>${signature}<br><br>
          <button class="copy-btn" onclick='copyText(\`${block.replace(/`/g,"\\`")}\`)'>üìã Copy block</button>
          <button class="copy-btn" onclick='copyText(\`${token}\`)'>üîë Copy token</button>
          <a class="copy-btn" href="${jsonUrl}" download="bpc-signature-${address}.json">‚¨áÔ∏è Download JSON</a>
          <a class="copy-btn" href="${verifyLink}" target="_blank">üîó Verify via link</a>
        </div>
      `;
    } catch (err) {
      console.error(err);
      alert('Signing cancelled or failed.');
    }
  }
  function copyText(s){ navigator.clipboard.writeText(s||''); alert('Copied!'); }
</script>
</body>
</html>
