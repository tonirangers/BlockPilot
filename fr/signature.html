<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlockPilot ‚Äî Signature Officielle</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body data-lang="fr">
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="../fr/#overview"><img class="brand__logo" src="../logo.png" alt="BlockPilot" /></a>
        
        <div class="navSearch">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <span>Rechercher...</span>
          <kbd>‚åòK</kbd>
        </div>

        <button class="navToggle" id="navToggle">Menu</button>
        <div class="nav__links">
          <a href="../fr/#performance">Performance</a>
          <a href="../fr/#security">S√©curit√©</a>
          <a href="#docs" style="opacity:0.5;">Docs</a>
          <a href="./signature.html" class="active">Signature</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 class="h1">Signature & V√©rification</h1>
      <p class="p">Approuvez vos conditions ou v√©rifiez l'authenticit√© d'un document BPC, directement sur cette page.</p>

      <div class="scenarioChips" style="margin-bottom: 32px;">
        <button class="chip active" id="tabSign" onclick="toggleView('sign')">Signer un document</button>
        <button class="chip" id="tabVerify" onclick="toggleView('verify')">V√©rifier un token</button>
      </div>

      <div id="viewSign" class="bp-card">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="pill is-active" id="modeStd" onclick="setMode('standard')">Standard</button>
            <button class="pill" id="modeSeed" onclick="setMode('seed')">Seed</button>
        </div>

        <h2 class="cardTitle" id="docTitle">Conditions G√©n√©rales BPC</h2>
        <p class="cardSub">Signez avec votre wallet pour confirmer l'acceptation des termes.</p>

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin-top: 24px;">
          <a id="pdfLink" href="../BPC_Terms.pdf" target="_blank" class="btn">üìÑ Voir le PDF</a>
          <button id="signBtn" class="btn btn--primary" onclick="processSign()">‚úçÔ∏è Signer avec Metamask</button>
        </div>

        <div id="tokenResult" style="display:none; margin-top: 24px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
          <strong style="color: #166534;">‚úÖ Succ√®s ! Votre Token BPC1 :</strong>
          <div id="tokenValue" style="font-family: monospace; font-size: 11px; word-break: break-all; margin: 10px 0; background: #fff; padding: 10px; border-radius: 4px;"></div>
          <button class="btn" onclick="copyToken()" style="font-size: 12px;">Copier le token</button>
        </div>
      </div>

      <div id="viewVerify" class="bp-card" style="display:none;">
        <h2 class="cardTitle">V√©rifier un Token</h2>
        <p class="cardSub">Collez ici le token BPC1 pour authentifier la signature.</p>
        <textarea id="tokenInput" class="input" style="height: 120px; margin: 20px 0;" placeholder="BPC1.eyJhZGRyZXNzIjoiMHg..."></textarea>
        <button class="btn btn--primary" onclick="processVerify()">üîç V√©rifier la validit√©</button>
        <div id="verifyResult" style="margin-top:20px;"></div>
      </div>

    </div>
  </main>

  <footer class="footer">
    <div class="container">¬© BlockPilot 2025 ¬∑ <a href="https://t.me/tonirangers">Telegram</a></div>
  </footer>

  <script>
    // --- LOGIQUE UNIFI√âE (Anciennement dans sign.html) ---
    const PDFs = { standard: '../BPC_Terms.pdf', seed: '../BPC_Terms_Seed.pdf' };
    let currentMode = 'standard';

    function toggleView(view) {
      document.getElementById('viewSign').style.display = view === 'sign' ? 'block' : 'none';
      document.getElementById('viewVerify').style.display = view === 'verify' ? 'block' : 'none';
      document.getElementById('tabSign').classList.toggle('active', view === 'sign');
      document.getElementById('tabVerify').classList.toggle('active', view === 'verify');
    }

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('modeStd').classList.toggle('is-active', mode === 'standard');
      document.getElementById('modeSeed').classList.toggle('is-active', mode === 'seed');
      document.getElementById('docTitle').innerText = mode === 'standard' ? 'Conditions G√©n√©rales BPC' : 'Conditions Seed BPC';
      document.getElementById('pdfLink').href = PDFs[mode];
    }

    async function processSign() {
      if (!window.ethereum) return alert("Installez Metamask !");
      const btn = document.getElementById('signBtn');
      btn.disabled = true;
      btn.innerText = "‚è≥ En attente...";

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();

        // Calcul du Hash (Keccak256)
        const response = await fetch(PDFs[currentMode]);
        const pdfBuffer = await response.arrayBuffer();
        const pdfHash = '0x' + keccak256(new Uint8Array(pdfBuffer));

        const timestamp = new Date().toISOString();
        const msg = `J'accepte les conditions BPC (${currentMode})\nHash: ${pdfHash}\nDate: ${timestamp}`;
        const signature = await signer.signMessage(msg);

        const tokenData = { address, mode: currentMode, hash: pdfHash, sig: signature, date: timestamp };
        const b64Token = btoa(JSON.stringify(tokenData));
        
        document.getElementById('tokenResult').style.display = 'block';
        document.getElementById('tokenValue').innerText = "BPC1." + b64Token;
      } catch (e) {
        console.error(e);
        alert("Erreur lors de la signature.");
      } finally {
        btn.disabled = false;
        btn.innerText = "‚úçÔ∏è Signer avec Metamask";
      }
    }

    function copyToken() {
      navigator.clipboard.writeText(document.getElementById('tokenValue').innerText);
      alert("Copi√© !");
    }

    function processVerify() {
        const input = document.getElementById('tokenInput').value;
        const resultDiv = document.getElementById('verifyResult');
        try {
            const data = JSON.parse(atob(input.replace('BPC1.', '')));
            resultDiv.innerHTML = `<div class="mini"><strong>‚úÖ Valide</strong><br>Sign√© par : ${data.address}<br>Mode : ${data.mode}</div>`;
        } catch(e) {
            resultDiv.innerHTML = `<div class="mini" style="border-color:red; color:red;">‚ùå Token invalide</div>`;
        }
    }
  </script>
</body>
</html>
